<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Outside.fun</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    @font-face {
      font-family: 'Agipo';
      src: url('fonts/agipo-regular.otf') format('opentype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'Agipo';
      src: url('fonts/agipo-bold.otf') format('opentype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Agipo', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
      color: #1a1a1a;
      background: #f5f5f4;
      line-height: 1.5;
    }

    /* App Layout */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    /* Left Sidebar */
    .left-sidebar {
      width: 140px;
      background: #fafaf9;
      border-right: 1px solid #e7e5e4;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      left: 0;
      top: 0;
    }

    .sidebar-nav {
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      color: #57534e;
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      transition: all 0.15s;
    }

    .nav-item:hover {
      background: #f5f5f4;
      color: #1c1917;
    }

    .nav-item.active {
      background: #e7e5e4;
      color: #1c1917;
      font-weight: 600;
    }

    .nav-item-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .sidebar-footer {
      padding: 12px 16px;
      border-top: 1px solid #e7e5e4;
    }

    .settings-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #78716c;
      font-size: 13px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px 0;
    }

    .settings-btn:hover {
      color: #1c1917;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 140px;
      padding: 24px 32px;
      min-height: 100vh;
    }

    .main-content.with-sidebar {
      margin-right: 300px;
    }

    /* Right Sidebar */
    .right-sidebar {
      width: 300px;
      background: #ffffff;
      border-left: 1px solid #e7e5e4;
      padding: 24px;
      position: fixed;
      right: 0;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      color: #1c1917;
    }

    .page-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* List Selector */
    .list-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .list-dropdown {
      padding: 8px 12px;
      border: 1px solid #e7e5e4;
      border-radius: 6px;
      background: white;
      font-size: 14px;
      font-weight: 500;
      color: #1c1917;
      cursor: pointer;
      min-width: 180px;
    }

    .list-dropdown:focus {
      outline: none;
      border-color: #a8a29e;
    }

    .list-options-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e7e5e4;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 16px;
      color: #57534e;
    }

    .list-options-btn:hover {
      background: #f5f5f4;
    }

    /* Category Card */
    .category-card {
      background: #ffffff;
      border: 1px solid #e3e1dd;
      border-radius: 12px;
      margin-bottom: 0;
    }

    .categories-list > .category-card + .category-card {
      border-top: none;
      border-radius: 0;
    }

    .categories-list > .category-card:first-child {
      border-radius: 12px 12px 0 0;
    }

    .categories-list > .category-card:last-child {
      border-radius: 0 0 12px 12px;
    }

    .categories-list > .category-card:only-child {
      border-radius: 12px;
    }

    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 24px;
      cursor: pointer;
      user-select: none;
    }

    .category-header:hover {
      background: #fafaf9;
    }

    .categories-list > .category-card:first-child .category-header:hover {
      border-radius: 11px 11px 0 0;
    }

    .categories-list > .category-card:last-child .category-header:hover {
      border-radius: 0 0 11px 11px;
    }

    .categories-list > .category-card:only-child .category-header:hover {
      border-radius: 11px;
    }

    .category-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .collapse-icon {
      transition: transform 0.15s;
      width: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transform: rotate(0deg);
    }

    .collapse-icon.collapsed {
      transform: rotate(-90deg);
    }

    .collapse-icon svg {
      width: 11px;
      height: 7px;
      fill: none;
      stroke: #000000;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .category-emoji {
      font-size: 18px;
    }

    .category-name {
      font-weight: 700;
      font-size: 18px;
      color: #000000;
    }

    .category-header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .category-weight {
      font-size: 14px;
      font-weight: 700;
      color: #000000;
    }

    /* Items Table */
    .items-table {
      width: 100%;
      border-collapse: collapse;
    }

    .items-table th {
      text-align: left;
      padding: 10px 24px;
      font-size: 12px;
      font-weight: 700;
      color: #000000;
      opacity: 0.45;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-top: 1px solid #e3e1dd;
      border-bottom: 1px solid #e3e1dd;
    }

    .items-table td {
      padding: 14px 24px;
      border-bottom: 1px solid #e3e1dd;
      color: #000000;
      font-size: 14px;
    }

    .items-table tr:last-child td {
      border-bottom: none;
    }

    .items-table tr:hover td {
      background: #fafaf9;
    }

    .item-name {
      font-weight: 400;
      color: #000000;
    }

    .item-description {
      color: #000000;
    }

    .weight-auto-filled {
      color: #6366f1 !important;
    }

    .weight-auto-filled::after {
      content: ' âœ“';
      font-size: 10px;
    }

    .col-image { width: 40px; text-align: center; }
    .col-name { width: 15%; }
    .col-description { width: 35%; }
    .col-qty { width: 8%; text-align: center; }
    .col-weight { width: 12%; text-align: right; }
    .col-total { width: 12%; text-align: right; }
    .col-actions { width: 5%; text-align: center; }

    .item-image-cell {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      overflow: hidden;
      background: #f5f5f4;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
    }

    .item-image-cell:hover {
      background: #e7e5e4;
    }

    .item-image-cell img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .item-image-cell-placeholder {
      font-size: 14px;
      color: #a8a29e;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #a8a29e;
      cursor: pointer;
      font-size: 14px;
      padding: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .items-table tr:hover .delete-btn {
      opacity: 1;
    }

    .delete-btn:hover {
      color: #ef4444;
    }

    /* Add Item Row */
    .add-item-row {
      cursor: pointer;
    }

    .add-item-row td {
      color: #000000;
      opacity: 0.5;
      padding: 14px 24px;
    }

    .add-item-row:hover td {
      opacity: 0.7;
      background: transparent !important;
    }

    .add-item-text {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    /* Add Category Button */
    .add-category-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px 24px;
      color: #000000;
      opacity: 0.4;
      font-size: 18px;
      font-weight: 400;
      background: none;
      border: none;
      cursor: pointer;
      width: 100%;
    }

    .add-category-btn:hover {
      opacity: 0.6;
    }

    /* View Mode Toggle */
    .view-toggle {
      display: flex;
      gap: 4px;
      background: #f5f5f4;
      border-radius: 8px;
      padding: 4px;
    }

    .view-toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      color: #78716c;
      font-size: 16px;
      transition: all 0.15s;
    }

    .view-toggle-btn:hover {
      color: #44403c;
    }

    .view-toggle-btn.active {
      background: white;
      color: #1c1917;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Bag View - Flat Lay Style */
    .bag-view {
      background: #f8f7f6;
      border: 1px solid #e3e1dd;
      border-radius: 16px;
      padding: 40px;
      min-height: 600px;
      position: relative;
    }

    .bag-view-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    .bag-view-title {
      font-size: 14px;
      font-weight: 600;
      color: #78716c;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .bag-view-weight {
      font-size: 14px;
      color: #78716c;
      font-weight: 500;
    }

    /* Category clusters container */
    .bag-outline {
      /* Simple container, no backpack illustration */
    }

    /* Category clusters container */
    .bag-category-clusters {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .bag-cluster {
      background: rgba(255, 255, 255, 0.5);
      border-radius: 16px;
      padding: 16px;
    }

    .bag-cluster-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e7e5e4;
    }

    .bag-cluster-icon {
      font-size: 16px;
    }

    .bag-cluster-name {
      font-size: 13px;
      font-weight: 600;
      color: #44403c;
    }

    .bag-cluster-weight {
      font-size: 12px;
      color: #a8a29e;
      margin-left: auto;
    }

    /* Flat lay grid - CSS Grid for tetris-like packing */
    .bag-contents {
      display: grid;
      grid-template-columns: repeat(auto-fill, 40px);
      grid-auto-rows: 40px;
      gap: 6px;
      justify-content: start;
      align-content: start;
    }

    .bag-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #ffffff;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      padding: 6px;
      position: relative;
      overflow: hidden;
    }

    .bag-item:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 10;
    }

    .bag-item-image {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
      width: 100%;
    }

    .bag-item-image img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }

    .bag-item-placeholder {
      background: #f0efed;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #a8a29e;
      width: 70%;
      height: 70%;
    }

    .bag-item-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(255,255,255,0.95));
      padding: 4px 4px 3px;
      text-align: center;
    }

    .bag-item-name {
      font-weight: 500;
      color: #44403c;
      line-height: 1.1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: block;
    }

    .bag-item-weight {
      color: #a8a29e;
      display: block;
    }

    .bag-item-qty {
      position: absolute;
      top: 3px;
      right: 3px;
      background: #44403c;
      color: white;
      font-weight: 600;
      padding: 1px 5px;
      border-radius: 8px;
      font-size: 9px;
      z-index: 2;
    }

    .bag-item-wrapper {
      position: relative;
    }

    /* Shape & Size Combinations */
    /* XS - Tiny items (pills, small accessories) */
    .bag-item-xs-square { grid-column: span 1; grid-row: span 1; }
    .bag-item-xs-square .bag-item-name { font-size: 7px; }
    .bag-item-xs-square .bag-item-weight { font-size: 6px; }
    .bag-item-xs-square .bag-item-placeholder { font-size: 10px; }
    .bag-item-xs-square .bag-item-label { display: none; }

    .bag-item-xs-round { grid-column: span 1; grid-row: span 1; border-radius: 50%; }
    .bag-item-xs-round .bag-item-placeholder { border-radius: 50%; }
    .bag-item-xs-round .bag-item-label { display: none; }

    /* SM - Small items */
    .bag-item-sm-square { grid-column: span 2; grid-row: span 2; }
    .bag-item-sm-square .bag-item-name { font-size: 9px; }
    .bag-item-sm-square .bag-item-weight { font-size: 8px; }
    .bag-item-sm-square .bag-item-placeholder { font-size: 16px; }

    .bag-item-sm-round { grid-column: span 2; grid-row: span 2; border-radius: 50%; }
    .bag-item-sm-round .bag-item-placeholder { border-radius: 50%; font-size: 16px; }
    .bag-item-sm-round .bag-item-label { display: none; }

    .bag-item-sm-wide { grid-column: span 3; grid-row: span 1; border-radius: 20px; }
    .bag-item-sm-wide .bag-item-name { font-size: 8px; }
    .bag-item-sm-wide .bag-item-weight { font-size: 7px; }
    .bag-item-sm-wide .bag-item-placeholder { font-size: 12px; width: 50%; border-radius: 10px; }

    .bag-item-sm-tall { grid-column: span 1; grid-row: span 3; border-radius: 20px; }
    .bag-item-sm-tall .bag-item-name { font-size: 8px; writing-mode: vertical-rl; text-orientation: mixed; }
    .bag-item-sm-tall .bag-item-weight { display: none; }
    .bag-item-sm-tall .bag-item-placeholder { font-size: 12px; height: 50%; border-radius: 10px; }
    .bag-item-sm-tall .bag-item-label { display: none; }

    /* MD - Medium items */
    .bag-item-md-square { grid-column: span 3; grid-row: span 3; }
    .bag-item-md-square .bag-item-name { font-size: 10px; }
    .bag-item-md-square .bag-item-weight { font-size: 9px; }
    .bag-item-md-square .bag-item-placeholder { font-size: 20px; }

    .bag-item-md-round { grid-column: span 3; grid-row: span 3; border-radius: 50%; }
    .bag-item-md-round .bag-item-placeholder { border-radius: 50%; font-size: 20px; }
    .bag-item-md-round .bag-item-label { background: radial-gradient(ellipse at center bottom, rgba(255,255,255,0.9) 0%, transparent 70%); }

    .bag-item-md-wide { grid-column: span 4; grid-row: span 2; border-radius: 16px; }
    .bag-item-md-wide .bag-item-name { font-size: 10px; }
    .bag-item-md-wide .bag-item-weight { font-size: 9px; }
    .bag-item-md-wide .bag-item-placeholder { font-size: 18px; width: 60%; border-radius: 12px; }

    .bag-item-md-tall { grid-column: span 2; grid-row: span 4; border-radius: 16px; }
    .bag-item-md-tall .bag-item-name { font-size: 10px; }
    .bag-item-md-tall .bag-item-weight { font-size: 9px; }
    .bag-item-md-tall .bag-item-placeholder { font-size: 18px; height: 60%; border-radius: 12px; }

    /* LG - Large items */
    .bag-item-lg-square { grid-column: span 4; grid-row: span 4; }
    .bag-item-lg-square .bag-item-name { font-size: 11px; }
    .bag-item-lg-square .bag-item-weight { font-size: 10px; }
    .bag-item-lg-square .bag-item-placeholder { font-size: 28px; }

    .bag-item-lg-wide { grid-column: span 5; grid-row: span 3; border-radius: 20px; }
    .bag-item-lg-wide .bag-item-name { font-size: 11px; }
    .bag-item-lg-wide .bag-item-weight { font-size: 10px; }
    .bag-item-lg-wide .bag-item-placeholder { font-size: 24px; width: 50%; border-radius: 16px; }

    .bag-item-lg-tall { grid-column: span 3; grid-row: span 5; border-radius: 20px; }
    .bag-item-lg-tall .bag-item-name { font-size: 11px; }
    .bag-item-lg-tall .bag-item-weight { font-size: 10px; }
    .bag-item-lg-tall .bag-item-placeholder { font-size: 24px; height: 50%; border-radius: 16px; }

    .bag-item-lg-round { grid-column: span 4; grid-row: span 4; border-radius: 50%; }
    .bag-item-lg-round .bag-item-placeholder { border-radius: 50%; font-size: 28px; }
    .bag-item-lg-round .bag-item-label { background: radial-gradient(ellipse at center bottom, rgba(255,255,255,0.9) 0%, transparent 70%); }

    /* XL - Extra large items (tents, backpacks) */
    .bag-item-xl-square { grid-column: span 5; grid-row: span 5; }
    .bag-item-xl-square .bag-item-name { font-size: 12px; }
    .bag-item-xl-square .bag-item-weight { font-size: 11px; }
    .bag-item-xl-square .bag-item-placeholder { font-size: 36px; }

    .bag-item-xl-wide { grid-column: span 6; grid-row: span 4; border-radius: 24px; }
    .bag-item-xl-wide .bag-item-name { font-size: 12px; }
    .bag-item-xl-wide .bag-item-weight { font-size: 11px; }
    .bag-item-xl-wide .bag-item-placeholder { font-size: 32px; width: 50%; border-radius: 20px; }

    .bag-item-xl-tall { grid-column: span 4; grid-row: span 6; border-radius: 24px; }
    .bag-item-xl-tall .bag-item-name { font-size: 12px; }
    .bag-item-xl-tall .bag-item-weight { font-size: 11px; }
    .bag-item-xl-tall .bag-item-placeholder { font-size: 32px; height: 50%; border-radius: 20px; }

    /* Legacy category styles (hidden by default in new layout) */
    .bag-categories { display: none; }

    /* Item Image Modal */
    .item-image-field {
      margin-top: 8px;
    }

    .item-image-preview {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      background: #f5f5f4;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin-top: 8px;
    }

    .item-image-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* Options Menu */
    .options-btn {
      background: none;
      border: none;
      color: #d6d3d1;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 18px;
      letter-spacing: 2px;
      border-radius: 4px;
    }

    .options-btn:hover {
      background: #f5f5f4;
      color: #78716c;
    }

    .options-dropdown {
      position: relative;
      z-index: 1;
    }

    .options-dropdown.is-open {
      z-index: 9999;
    }

    .options-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border: 1px solid #e7e5e4;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
      min-width: 180px;
      overflow: hidden;
      z-index: 9999;
    }

    .options-menu-item {
      display: block;
      width: 100%;
      padding: 10px 16px;
      font-size: 13px;
      color: #44403c;
      background: none;
      border: none;
      text-align: left;
      cursor: pointer;
    }

    .options-menu-item:hover {
      background: #f5f5f4;
    }

    .options-menu-item.danger {
      color: #ef4444;
    }

    .options-menu-divider {
      height: 1px;
      background: #e7e5e4;
      margin: 4px 0;
    }

    /* Right Sidebar Content */
    .chart-section {
      margin-bottom: 32px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: #1c1917;
      margin-bottom: 20px;
      text-align: center;
    }

    .chart-container {
      position: relative;
      height: 180px;
      margin-bottom: 16px;
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      justify-content: center;
      font-size: 10px;
      color: #78716c;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    /* Weight Summary */
    .weight-summary {
      background: #fafaf9;
      border-radius: 8px;
      padding: 16px;
    }

    .weight-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .weight-row:not(:last-child) {
      border-bottom: 1px solid #e7e5e4;
    }

    .weight-row-label {
      font-size: 14px;
      color: #57534e;
    }

    .weight-row-value {
      font-size: 14px;
      font-weight: 600;
      color: #1c1917;
    }

    .weight-row.total .weight-row-label,
    .weight-row.total .weight-row-value {
      font-weight: 600;
    }

    .weight-row.separate {
      margin-top: 8px;
      padding-top: 16px;
      border-top: 1px solid #d6d3d1;
    }

    /* Editable Cell */
    .editable-cell {
      cursor: text;
      padding: 2px 4px;
      margin: -2px -4px;
      border-radius: 4px;
    }

    .editable-cell:hover {
      background: #f5f5f4;
    }

    .editable-cell input {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #d6d3d1;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
    }

    .editable-cell input:focus {
      border-color: #a8a29e;
      box-shadow: 0 0 0 2px rgba(168, 162, 158, 0.2);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e7e5e4;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #1c1917;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #a8a29e;
      cursor: pointer;
      padding: 4px;
    }

    .modal-close:hover {
      color: #57534e;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid #e7e5e4;
    }

    /* Form */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #57534e;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e7e5e4;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      color: #1c1917;
    }

    .form-input:focus {
      outline: none;
      border-color: #a8a29e;
      box-shadow: 0 0 0 2px rgba(168, 162, 158, 0.2);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
    }

    .btn-primary {
      background: #1c1917;
      color: white;
    }

    .btn-primary:hover {
      background: #292524;
    }

    .btn-secondary {
      background: #f5f5f4;
      color: #57534e;
      border: 1px solid #e7e5e4;
    }

    .btn-secondary:hover {
      background: #e7e5e4;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-fade-in {
      animation: fadeIn 0.15s ease-out;
    }

    /* ==================== Dashboard Styles ==================== */
    .dashboard-card {
      background: #ffffff;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .dashboard-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #f5f5f4;
    }

    .dashboard-card-title {
      font-size: 11px;
      font-weight: 600;
      color: #78716c;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .dashboard-card-body {
      padding: 20px;
    }

    .trip-date-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #57534e;
      margin-bottom: 16px;
    }

    .trip-date-row span {
      color: #1c1917;
      font-weight: 500;
    }

    .hike-selector {
      margin-bottom: 20px;
    }

    .hike-selector-label {
      font-size: 11px;
      color: #a8a29e;
      margin-bottom: 4px;
    }

    .hike-name {
      font-size: 28px;
      font-weight: 600;
      color: #1c1917;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hike-name select {
      font-size: 28px;
      font-weight: 600;
      color: #1c1917;
      border: none;
      background: none;
      cursor: pointer;
      padding-right: 24px;
    }

    .hike-description {
      font-size: 14px;
      color: #57534e;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .hike-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 13px;
      color: #57534e;
    }

    .hike-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Map placeholder */
    .map-placeholder {
      height: 200px;
      background: linear-gradient(135deg, #d4e4d4 0%, #a8c8a8 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #57534e;
      font-size: 14px;
      margin: 16px 0;
    }

    /* Leaflet Map */
    .map-container {
      height: 220px;
      border-radius: 8px;
      overflow: hidden;
      margin: 16px 0;
      border: 1px solid #e7e5e4;
    }

    .map-container-large {
      height: 300px;
    }

    /* GPX Upload */
    .gpx-upload {
      border: 2px dashed #d6d3d1;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafaf9;
    }

    .gpx-upload:hover {
      border-color: #a8a29e;
      background: #f5f5f4;
    }

    .gpx-upload.has-file {
      border-color: #22c55e;
      background: #f0fdf4;
    }

    .gpx-upload-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .gpx-upload-text {
      font-size: 13px;
      color: #78716c;
    }

    .gpx-upload-filename {
      font-size: 13px;
      font-weight: 500;
      color: #22c55e;
      margin-top: 4px;
    }

    .gpx-stats {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      font-size: 12px;
      color: #57534e;
      justify-content: center;
    }

    .gpx-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Gear Section in Dashboard */
    .gear-section {
      padding: 14px 20px;
      border-bottom: 1px solid #f5f5f4;
    }

    .gear-section:last-child {
      border-bottom: none;
    }

    .gear-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .gear-row-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .gear-row-label {
      font-size: 14px;
      color: #1c1917;
      min-width: 50px;
    }

    .gear-row-value {
      font-size: 14px;
      font-weight: 500;
      color: #1c1917;
    }

    /* Food Menu in Dashboard */
    .food-day {
      border-bottom: 1px solid #f5f5f4;
    }

    .food-day:last-child {
      border-bottom: none;
    }

    .food-day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      cursor: pointer;
      user-select: none;
    }

    .food-day-header:hover {
      background: #fafaf9;
    }

    .food-day-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .food-day-title {
      font-size: 14px;
      font-weight: 600;
      color: #1c1917;
    }

    .food-day-weight {
      font-size: 14px;
      color: #78716c;
    }

    .food-day-content {
      padding: 0 20px 16px 20px;
    }

    .food-meal-table {
      width: 100%;
      border-collapse: collapse;
    }

    .food-meal-table th {
      text-align: left;
      padding: 8px 12px;
      font-size: 10px;
      font-weight: 500;
      color: #a8a29e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .food-meal-table td {
      padding: 8px 12px;
      font-size: 13px;
      color: #44403c;
      border-bottom: 1px solid #f5f5f4;
    }

    .food-meal-table tr:last-child td {
      border-bottom: none;
    }

    .meal-type-cell {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .meal-dropdown {
      padding: 4px 8px;
      border: 1px solid #e7e5e4;
      border-radius: 4px;
      font-size: 13px;
      background: white;
      cursor: pointer;
    }

    .meal-dropdown:focus {
      outline: none;
      border-color: #a8a29e;
    }

    /* ==================== Hikes Styles ==================== */
    .hikes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .hike-card {
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .hike-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .hike-card-image {
      height: 160px;
      background-size: cover;
      background-position: center;
      position: relative;
    }

    .hike-card-image-placeholder {
      height: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      background: linear-gradient(135deg, #d6d3d1 0%, #a8a29e 100%);
    }

    .hike-card-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 4px 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      font-size: 11px;
      font-weight: 500;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .hike-card-content {
      padding: 16px 20px;
    }

    .hike-card-title {
      font-size: 17px;
      font-weight: 600;
      color: #1c1917;
      margin-bottom: 8px;
    }

    .hike-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
      color: #78716c;
    }

    .hike-card-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Hike Detail */
    .hike-detail {
      max-width: 800px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 0;
      color: #78716c;
      font-size: 14px;
      font-weight: 500;
      background: none;
      border: none;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .back-btn:hover {
      color: #1c1917;
    }

    .hike-hero {
      position: relative;
      height: 280px;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 24px;
      background-size: cover;
      background-position: center;
    }

    .hike-hero-placeholder {
      height: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      background: linear-gradient(135deg, #d6d3d1 0%, #a8a29e 100%);
      border-radius: 16px;
      margin-bottom: 24px;
    }

    .hike-hero-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 32px 24px 24px;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
      color: white;
    }

    .hike-hero-title {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .hike-detail-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
    }

    .hike-detail-title {
      font-size: 16px;
      font-weight: 600;
      color: #1c1917;
      margin-bottom: 12px;
    }

    .hike-detail-text {
      font-size: 14px;
      color: #57534e;
      line-height: 1.7;
    }

    .hike-detail-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
    }

    .hike-stat-item {
      text-align: center;
      padding: 16px;
      background: #fafaf9;
      border-radius: 8px;
    }

    .hike-stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #1c1917;
      margin-bottom: 4px;
    }

    .hike-stat-label {
      font-size: 12px;
      color: #78716c;
    }

    /* Food View Styles */
    .recipes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .recipes-title {
      font-size: 20px;
      font-weight: 600;
      color: #1c1917;
    }

    .recipes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    .recipe-card {
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .recipe-card-image {
      height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      position: relative;
      background-size: cover;
      background-position: center;
    }

    .recipe-card-image.breakfast { background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%); }
    .recipe-card-image.lunch { background: linear-gradient(135deg, #dbeafe 0%, #60a5fa 100%); }
    .recipe-card-image.dinner { background: linear-gradient(135deg, #fce7f3 0%, #f472b6 100%); }
    .recipe-card-image.snack { background: linear-gradient(135deg, #d1fae5 0%, #34d399 100%); }

    .recipe-type-badge {
      position: absolute;
      top: 10px;
      right: 10px;
    }

    .recipe-card-content {
      padding: 16px;
    }

    .recipe-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .recipe-card-title {
      font-size: 15px;
      font-weight: 600;
      color: #1c1917;
    }

    .recipe-type-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: capitalize;
      backdrop-filter: blur(4px);
    }

    .recipe-type-badge.breakfast { background: rgba(254, 243, 199, 0.9); color: #92400e; }
    .recipe-type-badge.lunch { background: rgba(219, 234, 254, 0.9); color: #1e40af; }
    .recipe-type-badge.dinner { background: rgba(252, 231, 243, 0.9); color: #9d174d; }
    .recipe-type-badge.snack { background: rgba(209, 250, 229, 0.9); color: #065f46; }

    .recipe-stats {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: #78716c;
      margin-bottom: 12px;
    }

    .recipe-actions {
      display: flex;
      gap: 8px;
    }

    /* Ingredients table in modal */
    .ingredients-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    .ingredients-table th {
      text-align: left;
      padding: 8px;
      font-size: 11px;
      font-weight: 500;
      color: #a8a29e;
      text-transform: uppercase;
      background: #fafaf9;
    }

    .ingredients-table td {
      padding: 8px;
      border-bottom: 1px solid #f5f5f4;
    }

    .ingredients-table input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #e7e5e4;
      border-radius: 4px;
      font-size: 13px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #a8a29e;
    }

    .empty-state-title {
      font-size: 16px;
      font-weight: 500;
      color: #78716c;
      margin-bottom: 8px;
    }

    /* Trip form styles */
    .trip-form-section {
      margin-bottom: 24px;
    }

    .trip-form-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #57534e;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Section Title */
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #57534e;
      margin: 24px 0 12px 0;
    }

    .section-title:first-of-type {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ==================== Utility Functions ====================
    const generateId = () => Math.random().toString(36).substr(2, 9);

    const formatWeight = (grams) => {
      if (grams >= 1000) {
        return `${(grams / 1000).toFixed(2)} kg`;
      }
      return `${Math.round(grams)}g`;
    };

    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    };

    // ==================== Featherweight Gear Database ====================
    // Open source ultralight gear database with 40,000+ items
    // Source: https://github.com/MooseV2/featherweight
    const FeatherweightDB = {
      items: [],
      loaded: false,
      loading: false,

      async load() {
        if (this.loaded || this.loading) return;
        this.loading = true;

        try {
          // Check localStorage cache first
          const cached = localStorage.getItem('featherweightDB');
          const cacheTime = localStorage.getItem('featherweightDB_time');
          const oneWeek = 7 * 24 * 60 * 60 * 1000;

          if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < oneWeek) {
            this.items = JSON.parse(cached);
            this.loaded = true;
            this.loading = false;
            console.log(`Featherweight DB loaded from cache: ${this.items.length} items`);
            return;
          }

          // Fetch from GitHub
          const response = await fetch('https://moosev2.github.io/featherweight/assets/ul_items.txt');
          const text = await response.text();

          // Parse CSV: weight (in milligrams), item name
          this.items = text.trim().split('\n').map(line => {
            const commaIndex = line.indexOf(',');
            if (commaIndex === -1) return null;
            const weightMg = parseInt(line.slice(0, commaIndex));
            const name = line.slice(commaIndex + 1).trim();
            return {
              name: name,
              weight: weightMg / 1000, // Convert mg to grams
              nameLower: name.toLowerCase()
            };
          }).filter(item => item !== null);

          // Cache in localStorage
          localStorage.setItem('featherweightDB', JSON.stringify(this.items));
          localStorage.setItem('featherweightDB_time', Date.now().toString());

          this.loaded = true;
          console.log(`Featherweight DB loaded: ${this.items.length} items`);
        } catch (error) {
          console.error('Failed to load Featherweight DB:', error);
        }
        this.loading = false;
      },

      // Search for items matching a query
      search(query, limit = 10) {
        if (!this.loaded || !query) return [];

        const queryLower = query.toLowerCase().trim();
        const words = queryLower.split(/\s+/);

        // Score items by match quality
        const scored = this.items.map(item => {
          let score = 0;
          const nameLower = item.nameLower;

          // Exact match
          if (nameLower === queryLower) score += 100;
          // Starts with query
          else if (nameLower.startsWith(queryLower)) score += 50;
          // Contains full query
          else if (nameLower.includes(queryLower)) score += 30;
          // Contains all words
          else if (words.every(w => nameLower.includes(w))) score += 20;
          // Contains some words
          else {
            const matchedWords = words.filter(w => nameLower.includes(w));
            score += matchedWords.length * 5;
          }

          return { ...item, score };
        }).filter(item => item.score > 0);

        // Sort by score descending, then by name length (prefer shorter/simpler names)
        scored.sort((a, b) => {
          if (b.score !== a.score) return b.score - a.score;
          return a.name.length - b.name.length;
        });

        return scored.slice(0, limit);
      },

      // Find the best weight match for an item name
      findWeight(itemName) {
        const results = this.search(itemName, 1);
        return results.length > 0 ? results[0].weight : null;
      }
    };

    // Load database on startup
    FeatherweightDB.load();

    // ==================== GPX Parser ====================
    const parseGPX = (gpxString) => {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(gpxString, 'text/xml');

      const coordinates = [];
      let totalDistance = 0;
      let elevationGain = 0;
      let elevationLoss = 0;
      let minElevation = Infinity;
      let maxElevation = -Infinity;

      // Get track points
      const trkpts = xmlDoc.querySelectorAll('trkpt');
      const rtepts = xmlDoc.querySelectorAll('rtept');
      const wpts = xmlDoc.querySelectorAll('wpt');

      const points = trkpts.length > 0 ? trkpts : (rtepts.length > 0 ? rtepts : wpts);

      let prevLat = null;
      let prevLon = null;
      let prevEle = null;

      points.forEach((pt, index) => {
        const lat = parseFloat(pt.getAttribute('lat'));
        const lon = parseFloat(pt.getAttribute('lon'));
        const eleNode = pt.querySelector('ele');
        const ele = eleNode ? parseFloat(eleNode.textContent) : null;

        if (!isNaN(lat) && !isNaN(lon)) {
          coordinates.push([lat, lon, ele]);

          // Calculate elevation stats
          if (ele !== null) {
            if (ele < minElevation) minElevation = ele;
            if (ele > maxElevation) maxElevation = ele;

            if (prevEle !== null) {
              const eleDiff = ele - prevEle;
              if (eleDiff > 0) elevationGain += eleDiff;
              else elevationLoss += Math.abs(eleDiff);
            }
            prevEle = ele;
          }

          // Calculate distance using Haversine formula
          if (prevLat !== null && prevLon !== null) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat - prevLat) * Math.PI / 180;
            const dLon = (lon - prevLon) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(prevLat * Math.PI / 180) * Math.cos(lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            totalDistance += R * c;
          }

          prevLat = lat;
          prevLon = lon;
        }
      });

      // Get track name
      const nameNode = xmlDoc.querySelector('trk > name') || xmlDoc.querySelector('name');
      const name = nameNode ? nameNode.textContent : null;

      return {
        coordinates,
        name,
        stats: {
          distance: totalDistance.toFixed(1),
          elevationGain: Math.round(elevationGain),
          elevationLoss: Math.round(elevationLoss),
          minElevation: minElevation === Infinity ? null : Math.round(minElevation),
          maxElevation: maxElevation === -Infinity ? null : Math.round(maxElevation),
          points: coordinates.length
        }
      };
    };

    // ==================== Category Icons ====================
    const categoryIcons = {
      'Backpack': 'ðŸŽ’',
      'Sleep & Shelter': 'â›º',
      'Electronics': 'ðŸ”‹',
      'Food (gear)': 'ðŸ³',
      'Clothes (storage)': 'ðŸ‘•',
      'Clothes (wear)': 'ðŸ§¥',
      'Bits': 'ðŸ§°',
      'default': 'ðŸ“¦'
    };

    const getCategoryIcon = (name) => categoryIcons[name] || categoryIcons['default'];

    // ==================== Default Data ====================
    const defaultGearCategories = [
      { id: generateId(), name: 'Backpack', icon: 'ðŸŽ’', items: [], collapsed: false },
      { id: generateId(), name: 'Sleep & Shelter', icon: 'â›º', items: [], collapsed: false },
      { id: generateId(), name: 'Electronics', icon: 'ðŸ”‹', items: [], collapsed: false },
      { id: generateId(), name: 'Food (gear)', icon: 'ðŸ³', items: [], collapsed: false },
      { id: generateId(), name: 'Clothes (storage)', icon: 'ðŸ‘•', items: [], collapsed: false },
      { id: generateId(), name: 'Bits', icon: 'ðŸ§°', items: [], collapsed: false },
      { id: generateId(), name: 'Clothes (wear)', icon: 'ðŸ§¥', items: [], collapsed: false },
    ];

    const createDefaultGearList = (name = 'My Gear List') => ({
      id: generateId(),
      name,
      createdAt: new Date().toISOString(),
      categories: defaultGearCategories.map(cat => ({ ...cat, id: generateId(), items: [] }))
    });

    // ==================== Default Recipes ====================
    const defaultRecipes = [
      // BREAKFAST (7 recipes)
      {
        id: generateId(),
        name: 'Overnight Oats with Nuts',
        type: 'breakfast',
        imageUrl: 'https://images.unsplash.com/photo-1517673400267-0251440c45dc?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Instant oats', weightGrams: 80, calories: 300 },
          { id: generateId(), name: 'Powdered milk', weightGrams: 20, calories: 100 },
          { id: generateId(), name: 'Mixed nuts', weightGrams: 30, calories: 180 },
          { id: generateId(), name: 'Dried cranberries', weightGrams: 20, calories: 65 },
          { id: generateId(), name: 'Chia seeds', weightGrams: 10, calories: 50 }
        ]
      },
      {
        id: generateId(),
        name: 'Peanut Butter Banana Wrap',
        type: 'breakfast',
        imageUrl: 'https://images.unsplash.com/photo-1619096252214-ef06c45683e3?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Tortilla wrap', weightGrams: 60, calories: 180 },
          { id: generateId(), name: 'Peanut butter', weightGrams: 40, calories: 240 },
          { id: generateId(), name: 'Banana chips', weightGrams: 30, calories: 150 },
          { id: generateId(), name: 'Honey packet', weightGrams: 15, calories: 45 }
        ]
      },
      {
        id: generateId(),
        name: 'Granola Power Bowl',
        type: 'breakfast',
        imageUrl: 'https://images.unsplash.com/photo-1525351484163-7529414344d8?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Granola', weightGrams: 100, calories: 450 },
          { id: generateId(), name: 'Powdered coconut milk', weightGrams: 25, calories: 120 },
          { id: generateId(), name: 'Dried mango', weightGrams: 25, calories: 80 }
        ]
      },
      {
        id: generateId(),
        name: 'Instant Pancake Mix',
        type: 'breakfast',
        imageUrl: 'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Pancake mix', weightGrams: 80, calories: 280 },
          { id: generateId(), name: 'Powdered egg', weightGrams: 15, calories: 80 },
          { id: generateId(), name: 'Maple syrup packet', weightGrams: 30, calories: 80 }
        ]
      },
      {
        id: generateId(),
        name: 'Muesli with Apple',
        type: 'breakfast',
        imageUrl: 'https://images.unsplash.com/photo-1571748982800-fa51082c2224?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Muesli', weightGrams: 90, calories: 340 },
          { id: generateId(), name: 'Dried apple', weightGrams: 25, calories: 60 },
          { id: generateId(), name: 'Powdered milk', weightGrams: 20, calories: 100 },
          { id: generateId(), name: 'Cinnamon sugar', weightGrams: 5, calories: 20 }
        ]
      },
      {
        id: generateId(),
        name: 'Breakfast Couscous',
        type: 'breakfast',
        imageUrl: 'https://images.unsplash.com/photo-1623428187969-5da2dcea5ebf?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Couscous', weightGrams: 70, calories: 250 },
          { id: generateId(), name: 'Dried apricots', weightGrams: 30, calories: 70 },
          { id: generateId(), name: 'Almonds', weightGrams: 25, calories: 145 },
          { id: generateId(), name: 'Brown sugar', weightGrams: 15, calories: 55 }
        ]
      },
      {
        id: generateId(),
        name: 'Protein Porridge',
        type: 'breakfast',
        imageUrl: 'https://images.unsplash.com/photo-1495214783159-3503fd1b572d?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Oat flour', weightGrams: 60, calories: 230 },
          { id: generateId(), name: 'Protein powder', weightGrams: 30, calories: 120 },
          { id: generateId(), name: 'Peanut butter powder', weightGrams: 20, calories: 90 },
          { id: generateId(), name: 'Dried berries', weightGrams: 15, calories: 45 }
        ]
      },
      // LUNCH (7 recipes)
      {
        id: generateId(),
        name: 'Tuna Tortilla Wrap',
        type: 'lunch',
        imageUrl: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Tuna pouch', weightGrams: 75, calories: 90 },
          { id: generateId(), name: 'Tortilla wrap', weightGrams: 60, calories: 180 },
          { id: generateId(), name: 'Mayo packet', weightGrams: 15, calories: 100 },
          { id: generateId(), name: 'Dried vegetables', weightGrams: 10, calories: 30 }
        ]
      },
      {
        id: generateId(),
        name: 'Hummus & Crackers',
        type: 'lunch',
        imageUrl: 'https://images.unsplash.com/photo-1577805947697-89e18249d767?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Hummus powder', weightGrams: 50, calories: 200 },
          { id: generateId(), name: 'Crackers', weightGrams: 60, calories: 280 },
          { id: generateId(), name: 'Olive oil packet', weightGrams: 10, calories: 90 }
        ]
      },
      {
        id: generateId(),
        name: 'Salami & Cheese Roll-up',
        type: 'lunch',
        imageUrl: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Hard salami', weightGrams: 60, calories: 280 },
          { id: generateId(), name: 'Hard cheese', weightGrams: 50, calories: 200 },
          { id: generateId(), name: 'Tortilla', weightGrams: 60, calories: 180 }
        ]
      },
      {
        id: generateId(),
        name: 'Pita with Falafel Mix',
        type: 'lunch',
        imageUrl: 'https://images.unsplash.com/photo-1593001874117-c99c800e3eb4?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Pita bread', weightGrams: 60, calories: 165 },
          { id: generateId(), name: 'Falafel mix', weightGrams: 50, calories: 180 },
          { id: generateId(), name: 'Tahini powder', weightGrams: 20, calories: 120 }
        ]
      },
      {
        id: generateId(),
        name: 'Nut Butter Bagel',
        type: 'lunch',
        imageUrl: 'https://images.unsplash.com/photo-1592767818438-0595cee3b36e?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Mini bagel', weightGrams: 70, calories: 190 },
          { id: generateId(), name: 'Almond butter', weightGrams: 40, calories: 260 },
          { id: generateId(), name: 'Honey', weightGrams: 15, calories: 45 }
        ]
      },
      {
        id: generateId(),
        name: 'Mediterranean Couscous',
        type: 'lunch',
        imageUrl: 'https://images.unsplash.com/photo-1505576399279-565b52d4ac71?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Couscous', weightGrams: 80, calories: 280 },
          { id: generateId(), name: 'Sun-dried tomatoes', weightGrams: 20, calories: 50 },
          { id: generateId(), name: 'Olive oil', weightGrams: 15, calories: 130 },
          { id: generateId(), name: 'Feta powder', weightGrams: 15, calories: 60 }
        ]
      },
      {
        id: generateId(),
        name: 'Chicken Salad Wrap',
        type: 'lunch',
        imageUrl: 'https://images.unsplash.com/photo-1600850056064-a8b380df8395?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Chicken pouch', weightGrams: 75, calories: 110 },
          { id: generateId(), name: 'Tortilla', weightGrams: 60, calories: 180 },
          { id: generateId(), name: 'Mayo packet', weightGrams: 15, calories: 100 },
          { id: generateId(), name: 'Dried onion flakes', weightGrams: 5, calories: 15 }
        ]
      },
      // DINNER (7 recipes)
      {
        id: generateId(),
        name: 'Instant Ramen Upgrade',
        type: 'dinner',
        imageUrl: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Ramen noodles', weightGrams: 85, calories: 380 },
          { id: generateId(), name: 'Dried vegetables', weightGrams: 15, calories: 40 },
          { id: generateId(), name: 'Peanut butter', weightGrams: 20, calories: 120 },
          { id: generateId(), name: 'Soy sauce packet', weightGrams: 10, calories: 5 }
        ]
      },
      {
        id: generateId(),
        name: 'Backcountry Mac & Cheese',
        type: 'dinner',
        imageUrl: 'https://images.unsplash.com/photo-1543339494-b4cd4f7ba686?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Pasta', weightGrams: 100, calories: 350 },
          { id: generateId(), name: 'Cheese powder', weightGrams: 30, calories: 150 },
          { id: generateId(), name: 'Powdered milk', weightGrams: 20, calories: 100 },
          { id: generateId(), name: 'Bacon bits', weightGrams: 20, calories: 100 }
        ]
      },
      {
        id: generateId(),
        name: 'Coconut Curry Rice',
        type: 'dinner',
        imageUrl: 'https://images.unsplash.com/photo-1455619452474-d2be8b1e70cd?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Instant rice', weightGrams: 90, calories: 320 },
          { id: generateId(), name: 'Coconut milk powder', weightGrams: 30, calories: 150 },
          { id: generateId(), name: 'Curry powder', weightGrams: 5, calories: 15 },
          { id: generateId(), name: 'Dried peas', weightGrams: 25, calories: 85 }
        ]
      },
      {
        id: generateId(),
        name: 'Mashed Potato Bowl',
        type: 'dinner',
        imageUrl: 'https://images.unsplash.com/photo-1600984575359-310ae7b6bdf2?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Instant mashed potatoes', weightGrams: 80, calories: 280 },
          { id: generateId(), name: 'Bacon bits', weightGrams: 25, calories: 130 },
          { id: generateId(), name: 'Cheese powder', weightGrams: 20, calories: 100 },
          { id: generateId(), name: 'Dried chives', weightGrams: 5, calories: 5 }
        ]
      },
      {
        id: generateId(),
        name: 'Lentil Soup Mix',
        type: 'dinner',
        imageUrl: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Red lentils', weightGrams: 80, calories: 280 },
          { id: generateId(), name: 'Dried vegetables', weightGrams: 20, calories: 50 },
          { id: generateId(), name: 'Spice mix', weightGrams: 5, calories: 10 },
          { id: generateId(), name: 'Olive oil', weightGrams: 15, calories: 130 }
        ]
      },
      {
        id: generateId(),
        name: 'Pasta Primavera',
        type: 'dinner',
        imageUrl: 'https://images.unsplash.com/photo-1473093295043-cdd812d0e601?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Angel hair pasta', weightGrams: 100, calories: 350 },
          { id: generateId(), name: 'Dried vegetables', weightGrams: 25, calories: 60 },
          { id: generateId(), name: 'Parmesan powder', weightGrams: 20, calories: 80 },
          { id: generateId(), name: 'Olive oil', weightGrams: 15, calories: 130 }
        ]
      },
      {
        id: generateId(),
        name: 'Quinoa Mexican Bowl',
        type: 'dinner',
        imageUrl: 'https://images.unsplash.com/photo-1546793665-c74683f339c1?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Instant quinoa', weightGrams: 80, calories: 290 },
          { id: generateId(), name: 'Black bean flakes', weightGrams: 30, calories: 100 },
          { id: generateId(), name: 'Taco seasoning', weightGrams: 10, calories: 25 },
          { id: generateId(), name: 'Tortilla chips', weightGrams: 30, calories: 150 }
        ]
      },
      // SNACKS (4 recipes)
      {
        id: generateId(),
        name: 'Trail Mix Energy',
        type: 'snack',
        imageUrl: 'https://images.unsplash.com/photo-1604068549290-dea0e4a305ca?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Mixed nuts', weightGrams: 40, calories: 240 },
          { id: generateId(), name: 'Dark chocolate chips', weightGrams: 20, calories: 110 },
          { id: generateId(), name: 'Dried fruit', weightGrams: 25, calories: 70 }
        ]
      },
      {
        id: generateId(),
        name: 'Homemade Energy Bar',
        type: 'snack',
        imageUrl: 'https://images.unsplash.com/photo-1622484212850-eb596d769edc?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Oats', weightGrams: 30, calories: 115 },
          { id: generateId(), name: 'Peanut butter', weightGrams: 25, calories: 150 },
          { id: generateId(), name: 'Honey', weightGrams: 20, calories: 60 },
          { id: generateId(), name: 'Chocolate chips', weightGrams: 15, calories: 80 }
        ]
      },
      {
        id: generateId(),
        name: 'Nut Butter Packet',
        type: 'snack',
        imageUrl: 'https://images.unsplash.com/photo-1612187209234-a5e07f618388?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Almond butter', weightGrams: 35, calories: 210 },
          { id: generateId(), name: 'Pretzel sticks', weightGrams: 30, calories: 110 }
        ]
      },
      {
        id: generateId(),
        name: 'Dried Fruit & Coconut',
        type: 'snack',
        imageUrl: 'https://images.unsplash.com/photo-1596591868231-05e882a04b4b?w=400&h=300&fit=crop',
        ingredients: [
          { id: generateId(), name: 'Dried mango', weightGrams: 35, calories: 110 },
          { id: generateId(), name: 'Coconut flakes', weightGrams: 25, calories: 160 },
          { id: generateId(), name: 'Macadamia nuts', weightGrams: 20, calories: 145 }
        ]
      }
    ];

    // ==================== Local Storage ====================
    const loadFromStorage = (key, defaultValue) => {
      try {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : defaultValue;
      } catch (e) {
        return defaultValue;
      }
    };

    const saveToStorage = (key, value) => {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.error('Storage error:', e);
      }
    };

    // ==================== Shared Components ====================
    const EditableCell = ({ value, onChange, type = 'text', placeholder = '', className = '' }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [tempValue, setTempValue] = useState(value);
      const inputRef = useRef(null);

      useEffect(() => { setTempValue(value); }, [value]);
      useEffect(() => {
        if (isEditing && inputRef.current) {
          inputRef.current.focus();
          inputRef.current.select();
        }
      }, [isEditing]);

      const handleBlur = () => {
        setIsEditing(false);
        if (tempValue !== value) {
          onChange(type === 'number' ? parseFloat(tempValue) || 0 : tempValue);
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter') handleBlur();
        if (e.key === 'Escape') { setTempValue(value); setIsEditing(false); }
      };

      if (isEditing) {
        return (
          <div className="editable-cell">
            <input ref={inputRef} type={type} value={tempValue}
              onChange={(e) => setTempValue(e.target.value)}
              onBlur={handleBlur} onKeyDown={handleKeyDown} />
          </div>
        );
      }

      return (
        <div className={`editable-cell ${className}`} onClick={() => setIsEditing(true)}>
          {value || <span style={{ color: '#a8a29e' }}>{placeholder || 'â€”'}</span>}
        </div>
      );
    };

    const OptionsDropdown = ({ options, trigger }) => {
      const [isOpen, setIsOpen] = useState(false);
      const ref = useRef(null);

      useEffect(() => {
        const handleClickOutside = (e) => {
          if (ref.current && !ref.current.contains(e.target)) setIsOpen(false);
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      return (
        <div className={`options-dropdown ${isOpen ? 'is-open' : ''}`} ref={ref}>
          {trigger ? (
            <div onClick={(e) => { e.stopPropagation(); setIsOpen(!isOpen); }}>{trigger}</div>
          ) : (
            <button className="options-btn" onClick={(e) => { e.stopPropagation(); setIsOpen(!isOpen); }}>â€¢â€¢â€¢</button>
          )}
          {isOpen && (
            <div className="options-menu animate-fade-in">
              {options.map((opt, i) =>
                opt.divider ? <div key={i} className="options-menu-divider" /> : (
                  <button key={i} className={`options-menu-item ${opt.danger ? 'danger' : ''}`}
                    onClick={(e) => { e.stopPropagation(); opt.onClick(); setIsOpen(false); }}>
                    {opt.label}
                  </button>
                )
              )}
            </div>
          )}
        </div>
      );
    };

    const Modal = ({ title, children, onClose, footer }) => (
      <div className="modal-overlay" onClick={onClose}>
        <div className="modal animate-fade-in" onClick={(e) => e.stopPropagation()}>
          <div className="modal-header">
            <h2 className="modal-title">{title}</h2>
            <button className="modal-close" onClick={onClose}>Ã—</button>
          </div>
          <div className="modal-body">{children}</div>
          {footer && <div className="modal-footer">{footer}</div>}
        </div>
      </div>
    );

    // ==================== GPX Map Component ====================
    const GPXMap = ({ coordinates, className = '' }) => {
      const mapRef = useRef(null);
      const mapInstanceRef = useRef(null);
      const polylineRef = useRef(null);

      useEffect(() => {
        if (!mapRef.current || !coordinates || coordinates.length === 0) return;

        // Initialize map if not already done
        if (!mapInstanceRef.current) {
          mapInstanceRef.current = L.map(mapRef.current, {
            zoomControl: true,
            scrollWheelZoom: true
          });

          // Add OpenStreetMap tiles
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18
          }).addTo(mapInstanceRef.current);
        }

        // Remove existing polyline
        if (polylineRef.current) {
          mapInstanceRef.current.removeLayer(polylineRef.current);
        }

        // Create polyline from coordinates
        const latLngs = coordinates.map(coord => [coord[0], coord[1]]);
        polylineRef.current = L.polyline(latLngs, {
          color: '#3b82f6',
          weight: 3,
          opacity: 0.8
        }).addTo(mapInstanceRef.current);

        // Add start and end markers
        if (latLngs.length > 0) {
          const startIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: #22c55e; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
            iconSize: [12, 12],
            iconAnchor: [6, 6]
          });
          const endIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: #ef4444; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
            iconSize: [12, 12],
            iconAnchor: [6, 6]
          });

          L.marker(latLngs[0], { icon: startIcon }).addTo(mapInstanceRef.current);
          L.marker(latLngs[latLngs.length - 1], { icon: endIcon }).addTo(mapInstanceRef.current);
        }

        // Fit bounds to show entire route
        mapInstanceRef.current.fitBounds(polylineRef.current.getBounds(), { padding: [20, 20] });

        return () => {
          // Cleanup on unmount
        };
      }, [coordinates]);

      // Cleanup map on component unmount
      useEffect(() => {
        return () => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.remove();
            mapInstanceRef.current = null;
          }
        };
      }, []);

      if (!coordinates || coordinates.length === 0) {
        return (
          <div className="map-placeholder">
            ðŸ—ºï¸ No GPX data available
          </div>
        );
      }

      return <div ref={mapRef} className={`map-container ${className}`}></div>;
    };

    // ==================== GPX Upload Component ====================
    const GPXUpload = ({ value, onChange, onParsed }) => {
      const [isDragging, setIsDragging] = useState(false);
      const [fileName, setFileName] = useState(value?.fileName || '');
      const [stats, setStats] = useState(value?.stats || null);
      const inputRef = useRef(null);

      const handleFile = (file) => {
        if (!file || !file.name.toLowerCase().endsWith('.gpx')) {
          alert('Please upload a .gpx file');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const gpxString = e.target.result;
          const parsed = parseGPX(gpxString);

          setFileName(file.name);
          setStats(parsed.stats);

          onChange({
            fileName: file.name,
            coordinates: parsed.coordinates,
            stats: parsed.stats,
            gpxName: parsed.name
          });

          if (onParsed) {
            onParsed(parsed);
          }
        };
        reader.readAsText(file);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        const file = e.dataTransfer.files[0];
        handleFile(file);
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        setIsDragging(true);
      };

      const handleDragLeave = () => {
        setIsDragging(false);
      };

      const handleClick = () => {
        inputRef.current?.click();
      };

      const handleInputChange = (e) => {
        const file = e.target.files[0];
        handleFile(file);
      };

      const handleRemove = (e) => {
        e.stopPropagation();
        setFileName('');
        setStats(null);
        onChange(null);
      };

      return (
        <div
          className={`gpx-upload ${fileName ? 'has-file' : ''} ${isDragging ? 'dragging' : ''}`}
          onClick={handleClick}
          onDrop={handleDrop}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
        >
          <input
            ref={inputRef}
            type="file"
            accept=".gpx"
            onChange={handleInputChange}
            style={{ display: 'none' }}
          />
          <div className="gpx-upload-icon">{fileName ? 'âœ…' : 'ðŸ“'}</div>
          <div className="gpx-upload-text">
            {fileName ? 'GPX file loaded' : 'Drop GPX file here or click to upload'}
          </div>
          {fileName && (
            <>
              <div className="gpx-upload-filename">
                {fileName}
                <button
                  onClick={handleRemove}
                  style={{ marginLeft: 8, background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer' }}
                >
                  Ã—
                </button>
              </div>
              {stats && (
                <div className="gpx-stats">
                  <span className="gpx-stat">ðŸ“ {stats.distance} km</span>
                  <span className="gpx-stat">â¬†ï¸ {stats.elevationGain}m</span>
                  <span className="gpx-stat">ðŸ“ {stats.points} pts</span>
                </div>
              )}
            </>
          )}
        </div>
      );
    };

    // ==================== Elevation Profile Component ====================
    const ElevationProfile = ({ coordinates }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!canvasRef.current || !coordinates || coordinates.length === 0) return;

        // Extract elevation data and calculate cumulative distance
        const data = [];
        let cumulativeDistance = 0;

        for (let i = 0; i < coordinates.length; i++) {
          const coord = coordinates[i];
          const elevation = coord[2];

          if (elevation !== null && elevation !== undefined) {
            if (i > 0) {
              const prev = coordinates[i - 1];
              const R = 6371; // Earth's radius in km
              const dLat = (coord[0] - prev[0]) * Math.PI / 180;
              const dLon = (coord[1] - prev[1]) * Math.PI / 180;
              const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(prev[0] * Math.PI / 180) * Math.cos(coord[0] * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
              const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
              cumulativeDistance += R * c;
            }
            data.push({ x: cumulativeDistance, y: elevation });
          }
        }

        // Sample data if too many points (for performance)
        const maxPoints = 200;
        let sampledData = data;
        if (data.length > maxPoints) {
          const step = Math.ceil(data.length / maxPoints);
          sampledData = data.filter((_, i) => i % step === 0);
        }

        if (chartRef.current) chartRef.current.destroy();

        chartRef.current = new Chart(canvasRef.current, {
          type: 'line',
          data: {
            datasets: [{
              data: sampledData,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${Math.round(ctx.parsed.y)}m at ${ctx.parsed.x.toFixed(1)}km`
                }
              }
            },
            scales: {
              x: {
                type: 'linear',
                title: { display: false },
                ticks: {
                  callback: (val) => `${Math.round(val)} km`,
                  font: { size: 10 },
                  color: '#a8a29e'
                },
                grid: { color: '#f5f5f4' }
              },
              y: {
                title: { display: false },
                ticks: {
                  callback: (val) => `${val} m`,
                  font: { size: 10 },
                  color: '#a8a29e'
                },
                grid: { color: '#f5f5f4', drawBorder: false }
              }
            }
          }
        });

        return () => {
          if (chartRef.current) chartRef.current.destroy();
        };
      }, [coordinates]);

      if (!coordinates || coordinates.length === 0 || !coordinates.some(c => c[2] != null)) {
        return null;
      }

      return (
        <div style={{ height: 120, marginTop: 16 }}>
          <canvas ref={canvasRef}></canvas>
        </div>
      );
    };

    // ==================== Weight Chart ====================
    const WeightChart = ({ categories }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);
      const colors = ['#6366f1', '#a855f7', '#ec4899', '#f59e0b', '#22c55e', '#06b6d4', '#3b82f6'];

      const getCategoryWeight = (cat) => cat.items.reduce((sum, item) =>
        sum + ((item.weight || 0) * (item.quantity || 1)), 0);

      const gear = categories.filter(c => c.name !== 'Clothes (wear)').reduce((sum, c) => sum + getCategoryWeight(c), 0);
      const clothesWear = categories.filter(c => c.name === 'Clothes (wear)').reduce((sum, c) => sum + getCategoryWeight(c), 0);

      useEffect(() => {
        if (!canvasRef.current) return;
        const data = categories.map((cat, i) => ({
          label: cat.name, weight: getCategoryWeight(cat), color: colors[i % colors.length]
        })).filter(d => d.weight > 0);

        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(canvasRef.current, {
          type: 'pie',
          data: {
            labels: data.map(d => d.label),
            datasets: [{ data: data.map(d => d.weight), backgroundColor: data.map(d => d.color), borderWidth: 0 }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [categories]);

      const legendData = categories.map((cat, i) => ({
        name: cat.name, weight: getCategoryWeight(cat), color: colors[i % colors.length]
      })).filter(d => d.weight > 0);

      return (
        <>
          <div className="chart-section">
            <h3 className="chart-title">Weight distribution</h3>
            <div className="chart-container"><canvas ref={canvasRef}></canvas></div>
            <div className="chart-legend">
              {legendData.map((item, i) => (
                <div key={i} className="legend-item">
                  <div className="legend-color" style={{ background: item.color }}></div>
                  <span>{item.name}</span>
                </div>
              ))}
            </div>
          </div>
          <div className="weight-summary">
            <div className="weight-row">
              <span className="weight-row-label">Gear</span>
              <span className="weight-row-value">{formatWeight(gear)}</span>
            </div>
            <div className="weight-row total">
              <span className="weight-row-label">Total</span>
              <span className="weight-row-value">{formatWeight(gear + clothesWear)}</span>
            </div>
            <div className="weight-row separate">
              <span className="weight-row-label">Clothes (wear)</span>
              <span className="weight-row-value">{formatWeight(clothesWear)}</span>
            </div>
          </div>
        </>
      );
    };

    // ==================== Category Component ====================
    const Category = ({ category, onUpdate, onDelete, onAddItem, onUpdateItem, onDeleteItem }) => {
      const [collapsed, setCollapsed] = useState(category.collapsed);

      const getCategoryWeight = () => category.items.reduce((sum, item) =>
        sum + ((item.weight || 0) * (item.quantity || 1)), 0);

      const handleAddItem = () => {
        onAddItem(category.id, {
          id: generateId(), name: '', description: '', weight: 0, quantity: 1, imageUrl: ''
        });
      };

      return (
        <div className="category-card">
          <div className="category-header" onClick={() => setCollapsed(!collapsed)}>
            <div className="category-header-left">
              <span className={`collapse-icon ${collapsed ? 'collapsed' : ''}`}><svg viewBox="0 0 11 7"><polyline points="1,1 5.5,5.5 10,1" /></svg></span>
              <span className="category-emoji">{category.icon}</span>
              <span className="category-name">{category.name}</span>
            </div>
            <div className="category-header-right">
              <span className="category-weight">{formatWeight(getCategoryWeight())}</span>
              <OptionsDropdown options={[
                { label: 'Rename', onClick: () => {
                  const name = prompt('Category name:', category.name);
                  if (name) onUpdate({ ...category, name });
                }},
                { label: 'Delete', onClick: () => onDelete(category.id), danger: true }
              ]} />
            </div>
          </div>
          {!collapsed && (
            <table className="items-table">
              <thead>
                <tr>
                  <th className="col-image"></th>
                  <th className="col-name">Name</th>
                  <th className="col-description">Description</th>
                  <th className="col-qty">Qty</th>
                  <th className="col-weight">Weight</th>
                  <th className="col-total">Total</th>
                  <th className="col-actions"></th>
                </tr>
              </thead>
              <tbody>
                {category.items.map(item => (
                  <tr key={item.id}>
                    <td>
                      <div
                        className="item-image-cell"
                        onClick={() => {
                          const url = prompt('Image URL (transparent PNG recommended):', item.imageUrl || '');
                          if (url !== null) onUpdateItem(category.id, { ...item, imageUrl: url });
                        }}
                        title="Click to add image"
                      >
                        {item.imageUrl ? (
                          <img src={item.imageUrl} alt={item.name} />
                        ) : (
                          <span className="item-image-cell-placeholder">+</span>
                        )}
                      </div>
                    </td>
                    <td><EditableCell value={item.name} onChange={(v) => {
                      const updates = { ...item, name: v };
                      // Auto-fill weight from Featherweight DB if weight is empty/zero
                      if (v && (!item.weight || item.weight === 0)) {
                        const dbWeight = FeatherweightDB.findWeight(v);
                        if (dbWeight) {
                          updates.weight = Math.round(dbWeight);
                          updates.weightAutoFilled = true;
                        }
                      }
                      onUpdateItem(category.id, updates);
                    }} placeholder="Item name" className="item-name" /></td>
                    <td><EditableCell value={item.description} onChange={(v) => onUpdateItem(category.id, { ...item, description: v })} placeholder="Description" className="item-description" /></td>
                    <td style={{ textAlign: 'center' }}><EditableCell value={item.quantity || 1} onChange={(v) => onUpdateItem(category.id, { ...item, quantity: parseInt(v) || 1 })} type="number" /></td>
                    <td style={{ textAlign: 'right' }} title={item.weightAutoFilled ? 'Weight auto-filled from Featherweight database' : ''}>
                      <EditableCell
                        value={item.weight ? `${item.weight}g` : ''}
                        onChange={(v) => onUpdateItem(category.id, { ...item, weight: parseFloat(v) || 0, weightAutoFilled: false })}
                        placeholder="0g"
                        className={item.weightAutoFilled ? 'weight-auto-filled' : ''}
                      />
                    </td>
                    <td style={{ textAlign: 'right' }}>{formatWeight((item.weight || 0) * (item.quantity || 1))}</td>
                    <td><button className="delete-btn" onClick={() => onDeleteItem(category.id, item.id)}>Ã—</button></td>
                  </tr>
                ))}
                <tr className="add-item-row" onClick={handleAddItem}>
                  <td colSpan="7"><div className="add-item-text"><span>+</span> Add new item</div></td>
                </tr>
              </tbody>
            </table>
          )}
        </div>
      );
    };

    // ==================== Bag View ====================
    // Estimate item size and shape based on name, description, category, and weight
    const estimateItemSizeAndShape = (item, categoryName) => {
      const name = (item.name || '').toLowerCase();
      const desc = (item.description || '').toLowerCase();
      const cat = (categoryName || '').toLowerCase();
      const text = `${name} ${desc} ${cat}`;
      const weight = item.weight || 0;

      let size = 'md';
      let shape = 'square';

      // === SIZE ESTIMATION ===
      // Extra large items
      const xlPatterns = ['tent', 'tarp', 'shelter', 'hammock', 'backpack', 'bivy'];
      if (xlPatterns.some(p => text.includes(p))) size = 'xl';
      // Large items
      else if (['sleeping bag', 'quilt', 'sleeping pad', 'pad', 'mattress', 'jacket', 'pants', 'trousers', 'fleece', 'puffy', 'down jacket', 'rain jacket', 'cook set', 'cookset', 'pot', 'bear canister', 'dry bag', 'stuff sack', 'shirt', 'hoodie', 'sweater'].some(p => text.includes(p))) size = 'lg';
      // Small items
      else if (['toothbrush', 'toothpaste', 'floss', 'sunscreen', 'lip balm', 'chapstick', 'pills', 'medicine', 'band-aid', 'bandaid', 'lighter', 'match', 'earplugs', 'whistle', 'compass', 'thermometer', 'needle', 'thread', 'button', 'safety pin', 'sim card', 'memory card', 'sd card', 'usb', 'cable', 'adapter', 'batteries', 'battery', 'salt', 'pepper', 'seasoning', 'vitamin', 'ibuprofen', 'aspirin', 'tape', 'duct tape', 'repair', 'patch', 'guyline', 'cordage', 'mini', 'tiny', 'small', 'spork', 'knife', 'multi-tool', 'multitool'].some(p => text.includes(p))) size = 'sm';
      // Extra small items
      else if (['pill', 'tablet', 'capsule', 'coin', 'key', 'sim', 'micro', 'button'].some(p => text.includes(p))) size = 'xs';
      // Weight-based fallback
      else if (weight > 800) size = 'xl';
      else if (weight > 400) size = 'lg';
      else if (weight > 100) size = 'md';
      else if (weight > 30) size = 'sm';
      else if (weight > 0) size = 'xs';

      // === SHAPE ESTIMATION ===
      // Tall/vertical items (poles, bottles, rolled clothes, trekking poles)
      const tallPatterns = ['pole', 'poles', 'trekking', 'hiking pole', 'tent pole', 'bottle', 'flask', 'thermos', 'rolled', 'umbrella', 'tripod', 'monopod', 'stakes', 'stake', 'pegs'];
      if (tallPatterns.some(p => text.includes(p))) shape = 'tall';

      // Wide/horizontal items (sleeping pads, folded clothes, keyboards, tablets)
      const widePatterns = ['sleeping pad', 'pad', 'mattress', 'keyboard', 'tablet', 'laptop', 'folded', 'shirt', 't-shirt', 'tshirt', 'shorts', 'underwear', 'boxers', 'briefs', 'map', 'book', 'notebook', 'journal', 'towel', 'bandana', 'buff', 'ground sheet', 'footprint'];
      if (widePatterns.some(p => text.includes(p))) shape = 'wide';

      // Round items (pots, bowls, containers, canisters, tape rolls)
      const roundPatterns = ['pot', 'bowl', 'mug', 'cup', 'canister', 'fuel', 'gas', 'vaseline', 'balm', 'cream', 'lotion', 'sunscreen', 'container', 'jar', 'tin', 'puck', 'disc', 'roll', 'tape', 'lens', 'watch', 'compass', 'headlamp', 'lamp', 'light', 'lantern', 'stove', 'burner', 'cookware'];
      if (roundPatterns.some(p => text.includes(p))) shape = 'round';

      // Pants, trousers - tall and folded
      if (['pants', 'trousers', 'leggings', 'tights', 'long johns'].some(p => text.includes(p))) shape = 'tall';

      // Jackets, fleece - wide when folded
      if (['jacket', 'fleece', 'hoodie', 'sweater', 'puffy', 'down'].some(p => text.includes(p))) shape = 'wide';

      // Sleeping bags, quilts - wide cylinder
      if (['sleeping bag', 'quilt', 'blanket'].some(p => text.includes(p))) shape = 'wide';

      // Tents, tarps - usually packed wide
      if (['tent', 'tarp', 'shelter', 'fly'].some(p => text.includes(p))) shape = 'wide';

      // Socks, gloves - small square
      if (['socks', 'sock', 'gloves', 'glove', 'mittens', 'beanie', 'hat', 'cap'].some(p => text.includes(p))) shape = 'square';

      return { size, shape };
    };

    const BagView = ({ categories, onItemClick }) => {
      const getTotalWeight = () => categories.reduce((sum, cat) =>
        sum + cat.items.reduce((s, item) => s + ((item.weight || 0) * (item.quantity || 1)), 0), 0);

      const getCategoryWeight = (cat) => cat.items.reduce((sum, item) =>
        sum + ((item.weight || 0) * (item.quantity || 1)), 0);

      // Sort items within category: larger items first for better packing
      const sizeOrder = { xl: 0, lg: 1, md: 2, sm: 3, xs: 4 };
      const sortItemsBySize = (items, categoryName) => {
        return [...items].sort((a, b) => {
          const aSize = estimateItemSizeAndShape(a, categoryName).size;
          const bSize = estimateItemSizeAndShape(b, categoryName).size;
          return sizeOrder[aSize] - sizeOrder[bSize];
        });
      };

      return (
        <div className="bag-view">
          <div className="bag-view-header">
            <span className="bag-view-title">What's in the bag</span>
            <span className="bag-view-weight">{formatWeight(getTotalWeight())} total</span>
          </div>
          <div className="bag-outline">
            <div className="bag-category-clusters">
              {categories.map(cat => {
                const itemsWithContent = cat.items.filter(item => item.name);
                if (itemsWithContent.length === 0) return null;
                const sortedItems = sortItemsBySize(itemsWithContent, cat.name);

                return (
                  <div key={cat.id} className="bag-cluster">
                    <div className="bag-cluster-header">
                      <span className="bag-cluster-icon">{cat.icon}</span>
                      <span className="bag-cluster-name">{cat.name}</span>
                      <span className="bag-cluster-weight">{formatWeight(getCategoryWeight(cat))}</span>
                    </div>
                    <div className="bag-contents">
                      {sortedItems.map(item => {
                        const { size, shape } = estimateItemSizeAndShape(item, cat.name);
                        const sizeShapeClass = `bag-item-${size}-${shape}`;
                        return (
                          <div key={item.id} className={`bag-item ${sizeShapeClass}`} onClick={() => onItemClick && onItemClick(item)}>
                            {(item.quantity || 1) > 1 && (
                              <span className="bag-item-qty">Ã—{item.quantity}</span>
                            )}
                            <div className="bag-item-image">
                              {item.imageUrl ? (
                                <img src={item.imageUrl} alt={item.name} />
                              ) : (
                                <div className="bag-item-placeholder">{cat.icon || 'ðŸ“¦'}</div>
                              )}
                            </div>
                            <div className="bag-item-label">
                              <span className="bag-item-name">{item.name}</span>
                              <span className="bag-item-weight">{formatWeight((item.weight || 0) * (item.quantity || 1))}</span>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    };

    // ==================== Gear View ====================
    const GearView = ({ lists, currentListId, onSelectList, onUpdateList, onCreateList, onDuplicateList, onDeleteList, onRenameList }) => {
      const currentList = lists.find(l => l.id === currentListId);
      const [showListMenu, setShowListMenu] = useState(false);
      const [viewMode, setViewMode] = useState('list'); // 'list' or 'bag'

      const handleCategoryUpdate = (updated) => {
        const categories = currentList.categories.map(c => c.id === updated.id ? updated : c);
        onUpdateList({ ...currentList, categories });
      };

      const handleCategoryDelete = (id) => {
        if (confirm('Delete this category?')) {
          onUpdateList({ ...currentList, categories: currentList.categories.filter(c => c.id !== id) });
        }
      };

      const handleAddItem = (categoryId, item) => {
        const categories = currentList.categories.map(c =>
          c.id === categoryId ? { ...c, items: [...c.items, item] } : c
        );
        onUpdateList({ ...currentList, categories });
      };

      const handleUpdateItem = (categoryId, item) => {
        const categories = currentList.categories.map(c =>
          c.id === categoryId ? { ...c, items: c.items.map(i => i.id === item.id ? item : i) } : c
        );
        onUpdateList({ ...currentList, categories });
      };

      const handleDeleteItem = (categoryId, itemId) => {
        const categories = currentList.categories.map(c =>
          c.id === categoryId ? { ...c, items: c.items.filter(i => i.id !== itemId) } : c
        );
        onUpdateList({ ...currentList, categories });
      };

      const handleAddCategory = () => {
        const name = prompt('Category name:');
        if (name) {
          const newCat = { id: generateId(), name, icon: 'ðŸ“¦', items: [], collapsed: false };
          onUpdateList({ ...currentList, categories: [...currentList.categories, newCat] });
        }
      };

      const handleExportCSV = () => {
        // CSV format: Item Name, Category, desc, qty, weight, unit, url, price, worn, consumable
        let csv = 'Item Name,Category,desc,qty,weight,unit,url,price,worn,consumable\n';
        currentList.categories.forEach(cat => {
          cat.items.forEach(item => {
            const worn = cat.name === 'Clothes (wear)' ? '1' : '0';
            const consumable = item.consumable ? '1' : '0';
            csv += `${item.name || ''},${cat.name},${item.description || ''},${item.quantity || 1},${item.weight || 0},gram,${item.url || ''},${item.price || 0},${worn},${consumable}\n`;
          });
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentList.name}.csv`;
        a.click();
      };

      const handleImportCSV = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv';
        input.onchange = (e) => {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = (event) => {
            const text = event.target.result;
            const lines = text.split('\n');
            const header = lines[0].toLowerCase();
            const dataLines = lines.slice(1);
            const categoryMap = {};

            // Parse CSV - format: Item Name, Category, desc, qty, weight, unit, url, price, worn, consumable
            dataLines.forEach(line => {
              if (!line.trim()) return;

              // Simple CSV parsing (handles basic cases)
              const values = line.split(',').map(v => v.trim());
              if (values.length < 5) return;

              const [itemName, category, desc, qty, weight, unit, url, price, worn, consumable] = values;

              if (!category) return;

              // Normalize category name
              let catName = category;

              // Map common category variations
              const catMapping = {
                'sleep & shelter': 'Sleep & Shelter',
                'pack': 'Backpack',
                'electronics': 'Electronics',
                'bits': 'Bits',
                'food': 'Food (gear)',
                'clothes': 'Clothes (storage)'
              };

              const lowerCat = catName.toLowerCase();
              if (catMapping[lowerCat]) {
                catName = catMapping[lowerCat];
              }

              if (!categoryMap[catName]) categoryMap[catName] = [];
              categoryMap[catName].push({
                id: generateId(),
                name: itemName || '',
                description: desc || '',
                quantity: parseInt(qty) || 1,
                weight: parseFloat(weight) || 0,
                url: url || '',
                price: parseFloat(price) || 0,
                consumable: consumable === '1' || consumable === 'true',
                imageUrl: ''
              });
            });

            // Build new categories list
            const newCategories = currentList.categories.map(cat => ({
              ...cat,
              items: categoryMap[cat.name] ? [...cat.items, ...categoryMap[cat.name]] : cat.items
            }));

            // Add any new categories not in default list
            Object.keys(categoryMap).forEach(catName => {
              if (!newCategories.find(c => c.name === catName)) {
                const icon = getCategoryIcon(catName);
                newCategories.push({
                  id: generateId(),
                  name: catName,
                  icon: icon,
                  items: categoryMap[catName],
                  collapsed: false
                });
              }
            });

            onUpdateList({ ...currentList, categories: newCategories });
          };
          reader.readAsText(file);
        };
        input.click();
      };

      if (!currentList) return null;

      return (
        <>
          <div className="page-header">
            <h1 className="page-title">Gear</h1>
            <div className="page-header-actions">
              <div className="view-toggle">
                <button
                  className={`view-toggle-btn ${viewMode === 'list' ? 'active' : ''}`}
                  onClick={() => setViewMode('list')}
                  title="List view"
                >â˜°</button>
                <button
                  className={`view-toggle-btn ${viewMode === 'bag' ? 'active' : ''}`}
                  onClick={() => setViewMode('bag')}
                  title="Bag view"
                >ðŸŽ’</button>
              </div>
              <div className="list-selector">
                <select className="list-dropdown" value={currentListId} onChange={(e) => onSelectList(e.target.value)}>
                  {lists.map(list => <option key={list.id} value={list.id}>{list.name}</option>)}
                </select>
                <OptionsDropdown
                  trigger={<button className="list-options-btn">â€¢â€¢â€¢</button>}
                  options={[
                    { label: 'Change list title', onClick: () => {
                      const name = prompt('New list name:', currentList.name);
                      if (name) onRenameList(currentListId, name);
                    }},
                    { label: 'Duplicate list', onClick: () => onDuplicateList(currentListId) },
                    { divider: true },
                    { label: 'Import CSV', onClick: handleImportCSV },
                    { label: 'Export CSV', onClick: handleExportCSV },
                    { divider: true },
                    { label: 'Delete list', onClick: () => {
                      if (lists.length > 1 && confirm('Delete this list?')) onDeleteList(currentListId);
                    }, danger: true }
                  ]}
                />
              </div>
              <button className="btn btn-primary" onClick={onCreateList}>+ New List</button>
            </div>
          </div>

          {viewMode === 'list' ? (
            <>
              <div className="categories-list">
                {currentList.categories.map(cat => (
                  <Category key={cat.id} category={cat}
                    onUpdate={handleCategoryUpdate} onDelete={handleCategoryDelete}
                    onAddItem={handleAddItem} onUpdateItem={handleUpdateItem} onDeleteItem={handleDeleteItem} />
                ))}
              </div>
              <button className="add-category-btn" onClick={handleAddCategory}>+ Add new category</button>
            </>
          ) : (
            <BagView categories={currentList.categories} />
          )}
        </>
      );
    };

    // ==================== Hikes View ====================
    const HikesView = ({ hikes, onAddHike, onUpdateHike, onDeleteHike }) => {
      const [selectedHike, setSelectedHike] = useState(null);
      const [showForm, setShowForm] = useState(false);
      const [editingHike, setEditingHike] = useState(null);
      const [formData, setFormData] = useState({
        name: '', description: '', imageUrl: '', distance: '', elevation: '', duration: '', location: '', status: 'wishlist', gpxData: null
      });

      const openNew = () => {
        setFormData({ name: '', description: '', imageUrl: '', distance: '', elevation: '', duration: '', location: '', status: 'wishlist', gpxData: null });
        setEditingHike(null);
        setShowForm(true);
      };

      const openEdit = (hike) => {
        setFormData({ ...hike });
        setEditingHike(hike);
        setShowForm(true);
      };

      const handleSave = () => {
        const hike = { ...formData, id: editingHike?.id || generateId() };
        if (editingHike) {
          onUpdateHike(hike);
          if (selectedHike?.id === hike.id) setSelectedHike(hike);
        } else {
          onAddHike(hike);
        }
        setShowForm(false);
      };

      const getStatusLabel = (status) => ({ wishlist: 'Wishlist', planned: 'Planned', completed: 'Completed' }[status] || status);

      if (selectedHike) {
        return (
          <div className="hike-detail">
            <button className="back-btn" onClick={() => setSelectedHike(null)}>â† Back to all hikes</button>

            {selectedHike.imageUrl ? (
              <div className="hike-hero" style={{ backgroundImage: `url(${selectedHike.imageUrl})` }}>
                <div className="hike-hero-overlay">
                  <h1 className="hike-hero-title">{selectedHike.name}</h1>
                </div>
              </div>
            ) : (
              <div className="hike-hero-placeholder">ðŸ¥¾</div>
            )}

            <div className="hike-detail-card">
              <h3 className="hike-detail-title">About this hike</h3>
              <p className="hike-detail-text">{selectedHike.description || 'No description added yet.'}</p>
            </div>

            {selectedHike.gpxData?.coordinates?.length > 0 && (
              <div className="hike-detail-card" style={{ padding: 0, overflow: 'hidden' }}>
                <GPXMap coordinates={selectedHike.gpxData.coordinates} className="map-container-large" />
              </div>
            )}

            <div className="hike-detail-card">
              <div className="hike-detail-stats">
                {selectedHike.distance && <div className="hike-stat-item"><div className="hike-stat-value">{selectedHike.distance}</div><div className="hike-stat-label">Distance</div></div>}
                {selectedHike.elevation && <div className="hike-stat-item"><div className="hike-stat-value">{selectedHike.elevation}</div><div className="hike-stat-label">Elevation</div></div>}
                {selectedHike.duration && <div className="hike-stat-item"><div className="hike-stat-value">{selectedHike.duration}</div><div className="hike-stat-label">Duration</div></div>}
                {selectedHike.location && <div className="hike-stat-item"><div className="hike-stat-value">{selectedHike.location}</div><div className="hike-stat-label">Location</div></div>}
              </div>
            </div>

            <div style={{ display: 'flex', gap: 8, marginTop: 16 }}>
              <button className="btn btn-secondary" onClick={() => openEdit(selectedHike)}>Edit</button>
              <button className="btn btn-secondary" onClick={() => { if (confirm('Delete?')) { onDeleteHike(selectedHike.id); setSelectedHike(null); } }}>Delete</button>
            </div>

            {showForm && (
              <HikeFormModal formData={formData} setFormData={setFormData} onSave={handleSave} onClose={() => setShowForm(false)} isEditing={!!editingHike} />
            )}
          </div>
        );
      }

      return (
        <>
          <div className="page-header">
            <h1 className="page-title">Hikes</h1>
            <button className="btn btn-primary" onClick={openNew}>+ New Hike</button>
          </div>

          {hikes.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-title">No hikes yet</div>
              <p>Add hikes you want to do or have completed.</p>
            </div>
          ) : (
            <div className="hikes-grid">
              {hikes.map(hike => (
                <div key={hike.id} className="hike-card" onClick={() => setSelectedHike(hike)}>
                  {hike.imageUrl ? (
                    <div className="hike-card-image" style={{ backgroundImage: `url(${hike.imageUrl})` }}>
                      <span className="hike-card-badge">{getStatusLabel(hike.status)}</span>
                    </div>
                  ) : (
                    <div className="hike-card-image-placeholder">ðŸ¥¾</div>
                  )}
                  <div className="hike-card-content">
                    <h3 className="hike-card-title">{hike.name}</h3>
                    <div className="hike-card-meta">
                      {hike.distance && <span className="hike-card-meta-item">â†”ï¸ {hike.distance}</span>}
                      {hike.elevation && <span className="hike-card-meta-item">â†—ï¸ {hike.elevation}</span>}
                      {hike.location && <span className="hike-card-meta-item">ðŸ“ {hike.location}</span>}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}

          {showForm && (
            <HikeFormModal formData={formData} setFormData={setFormData} onSave={handleSave} onClose={() => setShowForm(false)} isEditing={!!editingHike} />
          )}
        </>
      );
    };

    const HikeFormModal = ({ formData, setFormData, onSave, onClose, isEditing }) => {
      const handleGPXChange = (gpxData) => {
        if (gpxData) {
          const updates = {
            gpxData: gpxData,
          };
          // Auto-fill distance and elevation if not already set
          if (!formData.distance && gpxData.stats?.distance) {
            updates.distance = `${gpxData.stats.distance} km`;
          }
          if (!formData.elevation && gpxData.stats?.elevationGain) {
            updates.elevation = `${gpxData.stats.elevationGain}m gain`;
          }
          // Use GPX track name if no name set
          if (!formData.name && gpxData.gpxName) {
            updates.name = gpxData.gpxName;
          }
          setFormData({ ...formData, ...updates });
        } else {
          setFormData({ ...formData, gpxData: null });
        }
      };

      return (
        <Modal title={isEditing ? 'Edit Hike' : 'New Hike'} onClose={onClose}
          footer={<><button className="btn btn-secondary" onClick={onClose}>Cancel</button><button className="btn btn-primary" onClick={onSave}>Save</button></>}>
          <div className="form-group">
            <label className="form-label">GPX Route File</label>
            <GPXUpload
              value={formData.gpxData}
              onChange={handleGPXChange}
            />
          </div>
          {formData.gpxData?.coordinates?.length > 0 && (
            <div className="form-group">
              <GPXMap coordinates={formData.gpxData.coordinates} />
            </div>
          )}
          <div className="form-group">
            <label className="form-label">Name *</label>
            <input className="form-input" value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })} placeholder="e.g. West Highland Way" />
          </div>
          <div className="form-group">
            <label className="form-label">Description</label>
            <textarea className="form-input form-textarea" value={formData.description} onChange={(e) => setFormData({ ...formData, description: e.target.value })} placeholder="Describe the hike..." />
          </div>
          <div className="form-group">
            <label className="form-label">Image URL</label>
            <input className="form-input" value={formData.imageUrl} onChange={(e) => setFormData({ ...formData, imageUrl: e.target.value })} placeholder="https://..." />
          </div>
          <div className="form-row">
            <div className="form-group">
              <label className="form-label">Distance</label>
              <input className="form-input" value={formData.distance} onChange={(e) => setFormData({ ...formData, distance: e.target.value })} placeholder="e.g. 154 km" />
            </div>
            <div className="form-group">
              <label className="form-label">Elevation</label>
              <input className="form-input" value={formData.elevation} onChange={(e) => setFormData({ ...formData, elevation: e.target.value })} placeholder="e.g. 3,690 m" />
            </div>
          </div>
          <div className="form-row">
            <div className="form-group">
              <label className="form-label">Duration</label>
              <input className="form-input" value={formData.duration} onChange={(e) => setFormData({ ...formData, duration: e.target.value })} placeholder="e.g. 6 days" />
            </div>
            <div className="form-group">
              <label className="form-label">Location</label>
              <input className="form-input" value={formData.location} onChange={(e) => setFormData({ ...formData, location: e.target.value })} placeholder="e.g. Scotland" />
            </div>
          </div>
          <div className="form-group">
            <label className="form-label">Status</label>
            <select className="form-input" value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value })}>
              <option value="wishlist">Wishlist</option>
              <option value="planned">Planned</option>
              <option value="completed">Completed</option>
            </select>
          </div>
        </Modal>
      );
    };

    // ==================== Food View ====================
    const FoodView = ({ recipes, onAddRecipe, onUpdateRecipe, onDeleteRecipe }) => {
      const [showModal, setShowModal] = useState(false);
      const [editing, setEditing] = useState(null);
      const [formData, setFormData] = useState({ name: '', type: 'breakfast', imageUrl: '', ingredients: [] });
      const [filterType, setFilterType] = useState('all');

      const openNew = () => { setFormData({ name: '', type: 'breakfast', imageUrl: '', ingredients: [] }); setEditing(null); setShowModal(true); };
      const openEdit = (recipe) => { setFormData(recipe); setEditing(recipe); setShowModal(true); };

      const handleSave = () => {
        const recipe = { ...formData, id: editing?.id || generateId() };
        editing ? onUpdateRecipe(recipe) : onAddRecipe(recipe);
        setShowModal(false);
      };

      const addIngredient = () => setFormData({ ...formData, ingredients: [...formData.ingredients, { id: generateId(), name: '', weightGrams: 0, calories: 0 }] });
      const updateIngredient = (i, field, value) => { const updated = [...formData.ingredients]; updated[i] = { ...updated[i], [field]: value }; setFormData({ ...formData, ingredients: updated }); };
      const removeIngredient = (i) => setFormData({ ...formData, ingredients: formData.ingredients.filter((_, idx) => idx !== i) });

      const getEmoji = (type) => ({ breakfast: 'ðŸ¥£', lunch: 'ðŸ¥™', dinner: 'ðŸ²', snack: 'ðŸ«' }[type] || 'ðŸ½ï¸');
      const getStats = (recipe) => ({ weight: recipe.ingredients.reduce((s, i) => s + (i.weightGrams || 0), 0), calories: recipe.ingredients.reduce((s, i) => s + (i.calories || 0), 0) });
      const getCaloriesPerGram = (recipe) => {
        const stats = getStats(recipe);
        return stats.weight > 0 ? (stats.calories / stats.weight).toFixed(1) : 0;
      };

      const filteredRecipes = filterType === 'all' ? recipes : recipes.filter(r => r.type === filterType);

      return (
        <>
          <div className="recipes-header">
            <h2 className="recipes-title">Recipes</h2>
            <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>
              <select className="form-input" style={{ width: 'auto', padding: '8px 12px' }} value={filterType} onChange={(e) => setFilterType(e.target.value)}>
                <option value="all">All types</option>
                <option value="breakfast">Breakfast</option>
                <option value="lunch">Lunch</option>
                <option value="dinner">Dinner</option>
                <option value="snack">Snacks</option>
              </select>
              <button className="btn btn-primary" onClick={openNew}>+ New Recipe</button>
            </div>
          </div>

          {filteredRecipes.length === 0 ? (
            <div className="empty-state"><div className="empty-state-title">No recipes yet</div><p>Create your first recipe.</p></div>
          ) : (
            <div className="recipes-grid">
              {filteredRecipes.map(recipe => {
                const stats = getStats(recipe);
                return (
                  <div key={recipe.id} className="recipe-card">
                    {recipe.imageUrl ? (
                      <div className="recipe-card-image" style={{ backgroundImage: `url(${recipe.imageUrl})`, backgroundSize: 'cover', backgroundPosition: 'center' }}>
                        <span className={`recipe-type-badge ${recipe.type}`} style={{ position: 'absolute', top: 10, right: 10 }}>{recipe.type}</span>
                      </div>
                    ) : (
                      <div className={`recipe-card-image ${recipe.type}`} style={{ position: 'relative' }}>
                        {getEmoji(recipe.type)}
                        <span className={`recipe-type-badge ${recipe.type}`} style={{ position: 'absolute', top: 10, right: 10 }}>{recipe.type}</span>
                      </div>
                    )}
                    <div className="recipe-card-content">
                      <div className="recipe-card-header">
                        <span className="recipe-card-title">{recipe.name}</span>
                      </div>
                      <div className="recipe-stats">
                        <span>ðŸ‹ï¸ {formatWeight(stats.weight)}</span>
                        <span>ðŸ”¥ {stats.calories} cal</span>
                        <span style={{ color: '#22c55e' }}>âš¡ {getCaloriesPerGram(recipe)} cal/g</span>
                      </div>
                      <div className="recipe-actions">
                        <button className="btn btn-secondary btn-small" onClick={() => openEdit(recipe)}>Edit</button>
                        <button className="btn btn-secondary btn-small" onClick={() => { if (confirm('Delete?')) onDeleteRecipe(recipe.id); }}>Delete</button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {showModal && (
            <Modal title={editing ? 'Edit Recipe' : 'New Recipe'} onClose={() => setShowModal(false)}
              footer={<><button className="btn btn-secondary" onClick={() => setShowModal(false)}>Cancel</button><button className="btn btn-primary" onClick={handleSave}>Save</button></>}>
              <div className="form-group"><label className="form-label">Name</label><input className="form-input" value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })} placeholder="Recipe name" /></div>
              <div className="form-row">
                <div className="form-group">
                  <label className="form-label">Type</label>
                  <select className="form-input" value={formData.type} onChange={(e) => setFormData({ ...formData, type: e.target.value })}>
                    <option value="breakfast">Breakfast</option><option value="lunch">Lunch</option><option value="dinner">Dinner</option><option value="snack">Snack</option>
                  </select>
                </div>
                <div className="form-group">
                  <label className="form-label">Image URL</label>
                  <input className="form-input" value={formData.imageUrl || ''} onChange={(e) => setFormData({ ...formData, imageUrl: e.target.value })} placeholder="https://..." />
                </div>
              </div>
              <div className="form-group">
                <label className="form-label">Ingredients</label>
                <table className="ingredients-table">
                  <thead><tr><th>Name</th><th style={{ width: 80 }}>Weight (g)</th><th style={{ width: 80 }}>Calories</th><th style={{ width: 40 }}></th></tr></thead>
                  <tbody>
                    {formData.ingredients.map((ing, i) => (
                      <tr key={ing.id}>
                        <td><input value={ing.name} onChange={(e) => updateIngredient(i, 'name', e.target.value)} placeholder="Ingredient name" /></td>
                        <td><input type="number" value={ing.weightGrams} onChange={(e) => updateIngredient(i, 'weightGrams', parseFloat(e.target.value) || 0)} /></td>
                        <td><input type="number" value={ing.calories} onChange={(e) => updateIngredient(i, 'calories', parseFloat(e.target.value) || 0)} /></td>
                        <td><button className="delete-btn" style={{ opacity: 1 }} onClick={() => removeIngredient(i)}>Ã—</button></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                <button className="btn btn-secondary btn-small" style={{ marginTop: 8 }} onClick={addIngredient}>+ Add Ingredient</button>
              </div>
            </Modal>
          )}
        </>
      );
    };

    // ==================== Dashboard View ====================
    const DashboardView = ({ trips, hikes, gearLists, recipes, onUpdateTrip, onAddTrip }) => {
      const [showTripForm, setShowTripForm] = useState(false);
      const [expandedDays, setExpandedDays] = useState({});

      const upcomingTrip = trips.find(t => t.status === 'upcoming') || trips[0];
      const [editingTrip, setEditingTrip] = useState(upcomingTrip);
      const [formData, setFormData] = useState(upcomingTrip || {
        id: generateId(), name: 'New Trip', hikeId: '', gearListId: '', startDate: '', endDate: '', status: 'upcoming', foodMenu: [], waterLiters: 2
      });

      useEffect(() => {
        if (upcomingTrip) {
          setEditingTrip(upcomingTrip);
          setFormData(upcomingTrip);
        }
      }, [trips]);

      const selectedHike = hikes.find(h => h.id === formData.hikeId);
      const selectedGearList = gearLists.find(l => l.id === formData.gearListId);

      const handleFieldChange = (field, value) => {
        const updated = { ...formData, [field]: value };
        setFormData(updated);
        if (editingTrip) {
          onUpdateTrip(updated);
        }
      };

      const handleCreateTrip = () => {
        const newTrip = {
          id: generateId(),
          name: 'New Trip',
          hikeId: hikes[0]?.id || '',
          gearListId: gearLists[0]?.id || '',
          startDate: '',
          endDate: '',
          status: 'upcoming',
          foodMenu: [],
          waterLiters: 2
        };
        onAddTrip(newTrip);
        setFormData(newTrip);
        setEditingTrip(newTrip);
      };

      const getDaysCount = () => {
        if (!formData.startDate || !formData.endDate) return 0;
        const start = new Date(formData.startDate);
        const end = new Date(formData.endDate);
        return Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
      };

      const daysCount = getDaysCount();

      const initFoodMenu = () => {
        if (daysCount > 0 && (!formData.foodMenu || formData.foodMenu.length !== daysCount)) {
          const menu = Array.from({ length: daysCount }, (_, i) => ({
            day: i + 1,
            meals: { breakfast: { recipeId: '', qty: 1 }, lunch: { recipeId: '', qty: 1 }, dinner: { recipeId: '', qty: 1 }, snacks: { recipeId: '', qty: 2 } }
          }));
          handleFieldChange('foodMenu', menu);
        }
      };

      useEffect(() => { initFoodMenu(); }, [daysCount]);

      const updateMeal = (dayIndex, mealType, field, value) => {
        const menu = [...(formData.foodMenu || [])];
        if (menu[dayIndex]) {
          const currentMeal = menu[dayIndex].meals?.[mealType] || { recipeId: '', qty: 1 };
          // Handle both old format (string) and new format (object)
          const mealObj = typeof currentMeal === 'string' ? { recipeId: currentMeal, qty: 1 } : currentMeal;
          menu[dayIndex] = {
            ...menu[dayIndex],
            meals: {
              ...menu[dayIndex].meals,
              [mealType]: { ...mealObj, [field]: value }
            }
          };
          handleFieldChange('foodMenu', menu);
        }
      };

      const getMealData = (day, mealType) => {
        const meal = day?.meals?.[mealType];
        // Handle both old format (string) and new format (object)
        if (typeof meal === 'string') {
          return { recipeId: meal, qty: 1 };
        }
        return meal || { recipeId: '', qty: 1 };
      };

      const getGearListWeight = () => {
        if (!selectedGearList) return 0;
        return selectedGearList.categories.reduce((sum, cat) =>
          sum + cat.items.reduce((s, item) => s + ((item.weight || 0) * (item.quantity || 1)), 0), 0);
      };

      const getTotalFoodWeight = () => {
        return (formData.foodMenu || []).reduce((sum, day) => sum + getDayFoodWeight(day), 0);
      };

      const getDayFoodWeight = (day) => {
        if (!day?.meals) return 0;
        return Object.keys(day.meals).reduce((sum, mealType) => {
          const mealData = getMealData(day, mealType);
          const recipe = recipes.find(r => r.id === mealData.recipeId);
          if (recipe) {
            const weight = recipe.ingredients.reduce((s, i) => s + (i.weightGrams || 0), 0);
            return sum + (weight * (mealData.qty || 1));
          }
          return sum;
        }, 0);
      };

      const getWaterWeight = () => (formData.waterLiters || 0) * 1000; // 1L = 1kg = 1000g

      const getTotalWeight = () => getGearListWeight() + getTotalFoodWeight() + getWaterWeight();

      if (!upcomingTrip && trips.length === 0) {
        return (
          <>
            <div className="page-header">
              <h1 className="page-title">Upcoming trip</h1>
              <button className="btn btn-primary" onClick={handleCreateTrip}>+ Create new trip</button>
            </div>
            <div className="empty-state">
              <div className="empty-state-title">No trips yet</div>
              <p>Create a trip to start planning.</p>
            </div>
          </>
        );
      }

      // Calculate speed if we have distance and duration
      const calculateSpeed = () => {
        if (!selectedHike?.gpxData?.stats?.distance) return null;
        const distance = parseFloat(selectedHike.gpxData.stats.distance);
        // Try to parse duration from hike
        const durationStr = selectedHike.duration || '';
        const hoursMatch = durationStr.match(/(\d+)\s*h/i);
        const daysMatch = durationStr.match(/(\d+)\s*d/i);
        let hours = 0;
        if (hoursMatch) hours = parseInt(hoursMatch[1]);
        if (daysMatch) hours = parseInt(daysMatch[1]) * 8; // Assume 8 hours of walking per day
        if (hours > 0) return (distance / hours).toFixed(1);
        return null;
      };

      const [showFullDescription, setShowFullDescription] = useState(false);
      const truncateDescription = (text, maxLength = 150) => {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
      };

      return (
        <>
          <div className="page-header">
            <h1 className="page-title">Upcoming trip</h1>
            <button className="btn btn-primary" onClick={handleCreateTrip}>+ Create new trip</button>
          </div>

          {/* Date and People Card */}
          <div className="dashboard-card">
            <div className="gear-section">
              <div className="gear-row">
                <div className="gear-row-left">
                  <span className="gear-row-label" style={{ fontWeight: 600 }}>Date:</span>
                  <span style={{ color: '#1c1917' }}>
                    {formData.startDate ? formatDate(formData.startDate) : 'Start'} â†’ {formData.endDate ? formatDate(formData.endDate) : 'End'}
                  </span>
                </div>
                <OptionsDropdown options={[
                  { label: 'Edit dates', onClick: () => {
                    const start = prompt('Start date (YYYY-MM-DD):', formData.startDate || '');
                    const end = prompt('End date (YYYY-MM-DD):', formData.endDate || '');
                    if (start) handleFieldChange('startDate', start);
                    if (end) handleFieldChange('endDate', end);
                  }},
                  { divider: true },
                  { label: 'Delete trip', onClick: () => {
                    if (confirm('Delete this trip?')) {
                      // Handle delete through parent
                    }
                  }, danger: true }
                ]} />
              </div>
            </div>
            <div className="gear-section">
              <div className="gear-row">
                <div className="gear-row-left">
                  <span className="gear-row-label" style={{ fontWeight: 600 }}>People:</span>
                  <input
                    type="text"
                    value={formData.people || ''}
                    onChange={(e) => handleFieldChange('people', e.target.value)}
                    placeholder="Add people..."
                    style={{ border: 'none', background: 'transparent', fontSize: 14, color: '#1c1917', flex: 1 }}
                  />
                </div>
                <OptionsDropdown options={[
                  { label: 'Edit people', onClick: () => {
                    const people = prompt('People joining (comma separated):', formData.people || '');
                    if (people !== null) handleFieldChange('people', people);
                  }}
                ]} />
              </div>
            </div>
          </div>

          {/* Hike Card */}
          <div className="section-title">Hike</div>
          <div className="dashboard-card">
            <div className="dashboard-card-body">
              <div className="hike-name">
                <select value={formData.hikeId || ''} onChange={(e) => handleFieldChange('hikeId', e.target.value)}>
                  <option value="">Select a hike...</option>
                  {hikes.map(h => <option key={h.id} value={h.id}>{h.name}</option>)}
                </select>
              </div>

              {selectedHike && (
                <>
                  <p className="hike-description">
                    {showFullDescription ? selectedHike.description : truncateDescription(selectedHike.description)}
                    {selectedHike.description && selectedHike.description.length > 150 && (
                      <span
                        onClick={() => setShowFullDescription(!showFullDescription)}
                        style={{ color: '#3b82f6', cursor: 'pointer', marginLeft: 4 }}
                      >
                        {showFullDescription ? 'Show less' : 'Read more'}
                      </span>
                    )}
                  </p>
                  <div className="hike-stats">
                    {selectedHike.duration && <span className="hike-stat">ðŸ• {selectedHike.duration}</span>}
                    {selectedHike.distance && <span className="hike-stat">â†”ï¸ {selectedHike.distance}</span>}
                    {calculateSpeed() && <span className="hike-stat">â±ï¸ {calculateSpeed()} km/h</span>}
                    {selectedHike.gpxData?.stats?.elevationGain && (
                      <span className="hike-stat">â†—ï¸ {selectedHike.gpxData.stats.elevationGain} m</span>
                    )}
                    {selectedHike.gpxData?.stats?.elevationLoss && (
                      <span className="hike-stat">â†˜ï¸ {selectedHike.gpxData.stats.elevationLoss} m</span>
                    )}
                  </div>
                  {selectedHike.gpxData?.coordinates?.length > 0 ? (
                    <>
                      <GPXMap coordinates={selectedHike.gpxData.coordinates} />
                      <ElevationProfile coordinates={selectedHike.gpxData.coordinates} />
                    </>
                  ) : (
                    <div className="map-placeholder">ðŸ—ºï¸ Upload a GPX file to see the route</div>
                  )}
                </>
              )}
            </div>
          </div>

          {/* Weight Card */}
          <div className="section-title">Weight</div>
          <div className="dashboard-card">
            <div className="gear-section">
              <div className="gear-row">
                <div className="gear-row-left">
                  <span className="gear-row-label" style={{ fontWeight: 600 }}>Gear</span>
                  <select className="meal-dropdown" value={formData.gearListId || ''} onChange={(e) => handleFieldChange('gearListId', e.target.value)}>
                    <option value="">Select gear list...</option>
                    {gearLists.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                  </select>
                </div>
                <span className="gear-row-value">{formatWeight(getGearListWeight())}</span>
              </div>
            </div>
            <div className="gear-section">
              <div className="gear-row">
                <div className="gear-row-left">
                  <span className="gear-row-label" style={{ fontWeight: 600 }}>Food</span>
                  <span style={{ color: '#78716c', fontSize: 13 }}>{daysCount} days</span>
                </div>
                <span className="gear-row-value">{formatWeight(getTotalFoodWeight())}</span>
              </div>
            </div>
            <div className="gear-section">
              <div className="gear-row">
                <div className="gear-row-left">
                  <span className="gear-row-label" style={{ fontWeight: 600 }}>Water</span>
                  <input
                    type="number"
                    value={formData.waterLiters || 2}
                    onChange={(e) => handleFieldChange('waterLiters', parseFloat(e.target.value) || 0)}
                    style={{ width: 40, border: 'none', background: 'transparent', fontSize: 13, color: '#78716c' }}
                    min="0"
                    step="0.5"
                  />
                  <span style={{ color: '#78716c', fontSize: 13 }}>Liters</span>
                </div>
                <span className="gear-row-value">{formatWeight(getWaterWeight())}</span>
              </div>
            </div>
            <div className="gear-section" style={{ background: '#fafaf9' }}>
              <div className="gear-row">
                <span className="gear-row-label" style={{ fontWeight: 700 }}>Total</span>
                <span className="gear-row-value" style={{ fontWeight: 700 }}>{formatWeight(getTotalWeight())}</span>
              </div>
            </div>
          </div>

          {/* Food Menu Card */}
          <div className="section-title">Food menu</div>
          <div className="dashboard-card">
            <div className="dashboard-card-header" style={{ borderBottom: 'none', paddingBottom: 0 }}>
              <span></span>
              <OptionsDropdown options={[{ label: 'Copy from previous day', onClick: () => {} }]} />
            </div>

            {daysCount === 0 ? (
              <div style={{ padding: 20, textAlign: 'center', color: '#a8a29e' }}>
                Set start and end dates to plan your food menu.
              </div>
            ) : (
              (formData.foodMenu || []).map((day, dayIndex) => {
                const dayWeight = getDayFoodWeight(day);
                return (
                  <div key={dayIndex} className="food-day">
                    <div className="food-day-header" onClick={() => setExpandedDays(prev => ({ ...prev, [dayIndex]: !prev[dayIndex] }))}>
                      <div className="food-day-left">
                        <span style={{ color: '#a8a29e', fontSize: 12 }}>{expandedDays[dayIndex] ? 'â–¼' : 'â€º'}</span>
                        <span className="food-day-title">Day {day.day}</span>
                      </div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                        <span className="food-day-weight">{formatWeight(dayWeight)}</span>
                        <OptionsDropdown options={[{ label: 'Copy to next day', onClick: () => {} }]} />
                      </div>
                    </div>
                    {expandedDays[dayIndex] && (
                      <div className="food-day-content">
                        <table className="food-meal-table">
                          <thead>
                            <tr>
                              <th style={{ width: '15%' }}>Type</th>
                              <th style={{ width: '35%' }}>Food</th>
                              <th style={{ width: '10%', textAlign: 'center' }}>Qty</th>
                              <th style={{ width: '12%', textAlign: 'right' }}>Calories</th>
                              <th style={{ width: '12%', textAlign: 'right' }}>Weight</th>
                              <th style={{ width: '12%', textAlign: 'right' }}>Total</th>
                              <th style={{ width: '4%' }}></th>
                            </tr>
                          </thead>
                          <tbody>
                            {['breakfast', 'lunch', 'dinner', 'snacks'].map(mealType => {
                              const mealData = getMealData(day, mealType);
                              const recipe = recipes.find(r => r.id === mealData.recipeId);
                              const weight = recipe?.ingredients.reduce((s, i) => s + (i.weightGrams || 0), 0) || 0;
                              const calories = recipe?.ingredients.reduce((s, i) => s + (i.calories || 0), 0) || 0;
                              const qty = mealData.qty || 1;
                              const mealEmoji = mealType === 'breakfast' ? 'ðŸ¥£' : mealType === 'lunch' ? 'ðŸ¥™' : mealType === 'dinner' ? 'ðŸ²' : 'ðŸ«';
                              return (
                                <tr key={mealType}>
                                  <td>
                                    <div className="meal-type-cell">
                                      {mealEmoji} {mealType.charAt(0).toUpperCase() + mealType.slice(1)}
                                    </div>
                                  </td>
                                  <td>
                                    <select
                                      className="meal-dropdown"
                                      value={mealData.recipeId || ''}
                                      onChange={(e) => updateMeal(dayIndex, mealType, 'recipeId', e.target.value)}
                                      style={{ width: '100%' }}
                                    >
                                      <option value="">Select...</option>
                                      {recipes.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                    </select>
                                  </td>
                                  <td style={{ textAlign: 'center' }}>
                                    <input
                                      type="number"
                                      value={qty}
                                      onChange={(e) => updateMeal(dayIndex, mealType, 'qty', parseInt(e.target.value) || 1)}
                                      style={{ width: 40, textAlign: 'center', border: '1px solid #e7e5e4', borderRadius: 4, padding: '2px 4px', fontSize: 13 }}
                                      min="1"
                                    />
                                  </td>
                                  <td style={{ textAlign: 'right' }}>{calories || '-'}</td>
                                  <td style={{ textAlign: 'right' }}>{weight ? formatWeight(weight) : '-'}</td>
                                  <td style={{ textAlign: 'right', fontWeight: 500 }}>{weight ? formatWeight(weight * qty) : '-'}</td>
                                  <td>
                                    <button
                                      className="delete-btn"
                                      style={{ opacity: mealData.recipeId ? 1 : 0.3 }}
                                      onClick={() => updateMeal(dayIndex, mealType, 'recipeId', '')}
                                    >
                                      Ã—
                                    </button>
                                  </td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                );
              })
            )}
          </div>
        </>
      );
    };

    // ==================== Main App ====================
    const App = () => {
      const [activeView, setActiveView] = useState('dashboard');

      const [gearLists, setGearLists] = useState(() => {
        // Check if we need to do a one-time reset (version flag)
        const resetVersion = 'v2-empty';
        if (localStorage.getItem('gearListResetVersion') !== resetVersion) {
          localStorage.removeItem('gearLists');
          localStorage.setItem('gearListResetVersion', resetVersion);
          return [createDefaultGearList()];
        }
        const stored = loadFromStorage('gearLists', null);
        return stored && stored.length > 0 ? stored : [createDefaultGearList()];
      });
      const [currentGearListId, setCurrentGearListId] = useState(() => gearLists[0]?.id);

      const [hikes, setHikes] = useState(() => loadFromStorage('hikes', []));
      const [recipes, setRecipes] = useState(() => {
        // Check if we need to load default recipes (version flag)
        const recipeVersion = 'v1-default-25';
        if (localStorage.getItem('recipeVersion') !== recipeVersion) {
          localStorage.removeItem('recipes');
          localStorage.setItem('recipeVersion', recipeVersion);
          return defaultRecipes;
        }
        const stored = loadFromStorage('recipes', null);
        return stored && stored.length > 0 ? stored : defaultRecipes;
      });
      const [trips, setTrips] = useState(() => loadFromStorage('trips', []));

      useEffect(() => { saveToStorage('gearLists', gearLists); }, [gearLists]);
      useEffect(() => { saveToStorage('hikes', hikes); }, [hikes]);
      useEffect(() => { saveToStorage('recipes', recipes); }, [recipes]);
      useEffect(() => { saveToStorage('trips', trips); }, [trips]);

      const currentGearList = gearLists.find(l => l.id === currentGearListId);

      const handleUpdateGearList = (updated) => setGearLists(gearLists.map(l => l.id === updated.id ? updated : l));
      const handleCreateGearList = () => {
        const name = prompt('New list name:', 'My Gear List');
        if (name) {
          const newList = createDefaultGearList(name);
          setGearLists([...gearLists, newList]);
          setCurrentGearListId(newList.id);
        }
      };
      const handleDuplicateGearList = (id) => {
        const list = gearLists.find(l => l.id === id);
        if (list) {
          const newList = { ...JSON.parse(JSON.stringify(list)), id: generateId(), name: `${list.name} (copy)` };
          setGearLists([...gearLists, newList]);
          setCurrentGearListId(newList.id);
        }
      };
      const handleDeleteGearList = (id) => {
        const remaining = gearLists.filter(l => l.id !== id);
        setGearLists(remaining);
        if (currentGearListId === id) setCurrentGearListId(remaining[0]?.id);
      };
      const handleRenameGearList = (id, name) => setGearLists(gearLists.map(l => l.id === id ? { ...l, name } : l));

      const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'ðŸ“Š' },
        { id: 'hikes', label: 'Hikes', icon: 'ðŸ¥¾' },
        { id: 'gear', label: 'Gear', icon: 'ðŸŽ’' },
        { id: 'food', label: 'Food', icon: 'ðŸ³' },
      ];

      const showSidebar = activeView === 'gear';

      return (
        <div className="app-layout">
          <aside className="left-sidebar">
            <nav className="sidebar-nav">
              {navItems.map(item => (
                <button key={item.id} className={`nav-item ${activeView === item.id ? 'active' : ''}`} onClick={() => setActiveView(item.id)}>
                  <span className="nav-item-icon">{item.icon}</span>
                  {item.label}
                </button>
              ))}
            </nav>
            <div className="sidebar-footer">
              <button className="settings-btn"><span className="nav-item-icon">âš™ï¸</span>Settings</button>
            </div>
          </aside>

          <main className={`main-content ${showSidebar ? 'with-sidebar' : ''}`}>
            {activeView === 'dashboard' && (
              <DashboardView
                trips={trips}
                hikes={hikes}
                gearLists={gearLists}
                recipes={recipes}
                onUpdateTrip={(trip) => setTrips(trips.map(t => t.id === trip.id ? trip : t))}
                onAddTrip={(trip) => setTrips([...trips, trip])}
              />
            )}
            {activeView === 'gear' && (
              <GearView
                lists={gearLists}
                currentListId={currentGearListId}
                onSelectList={setCurrentGearListId}
                onUpdateList={handleUpdateGearList}
                onCreateList={handleCreateGearList}
                onDuplicateList={handleDuplicateGearList}
                onDeleteList={handleDeleteGearList}
                onRenameList={handleRenameGearList}
              />
            )}
            {activeView === 'hikes' && (
              <HikesView
                hikes={hikes}
                onAddHike={(h) => setHikes([...hikes, h])}
                onUpdateHike={(h) => setHikes(hikes.map(x => x.id === h.id ? h : x))}
                onDeleteHike={(id) => setHikes(hikes.filter(h => h.id !== id))}
              />
            )}
            {activeView === 'food' && (
              <FoodView
                recipes={recipes}
                onAddRecipe={(r) => setRecipes([...recipes, r])}
                onUpdateRecipe={(r) => setRecipes(recipes.map(x => x.id === r.id ? r : x))}
                onDeleteRecipe={(id) => setRecipes(recipes.filter(r => r.id !== id))}
              />
            )}
          </main>

          {showSidebar && currentGearList && (
            <aside className="right-sidebar">
              <WeightChart categories={currentGearList.categories} />
            </aside>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
